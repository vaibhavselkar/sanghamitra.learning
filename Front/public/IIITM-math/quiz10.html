<!DOCTYPE html>      
<html lang="en">    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Sequence, Limits and Continuity Quiz</title>

    <!-- Add this right after <title> tag -->
        <script>
        window.MathJax = {
            tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
            fontCache: 'global'
            }
        };
        </script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
   
     <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

                /* MathJax styling */
        .MathJax_SVG, .MathJax_SVG_Display {
            max-width: 100% !important;
            overflow-x: auto !important;
        }

        .mjx-chtml {
            font-size: 110% !important;
        }

        .question-text mjx-container {
            display: inline-block !important;
            margin: 0 2px !important;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }

        .user-form {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        /* Anti-cheating CSS */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            -webkit-print-color-adjust: exact;
            pointer-events: auto;
        }
        
        /* Disable context menu */
        .no-context {
            pointer-events: none;
        }
        
        /* Hide scrollbars to prevent inspection */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        /* Blur content when window loses focus */
        body.blurred {
            filter: blur(5px);
            pointer-events: none;
        }
        
        /* Warning overlay */
        .warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 2rem;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
            transform: none; 
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-weight: 600;
        }

        .question-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn-nav {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-nav:hover:not(:disabled) {
            background: #545b62;
            transform: translateY(-1px);
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-next:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .question-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .status-answered {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-unanswered {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .quiz-container { padding: 30px; display: none; }

        .question-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            white-space: pre-line;
        }

        .options { display: flex; flex-direction: column; gap: 12px; }

        .option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover { border-color: #667eea; background: #f0f8ff; }
        .option.selected { border-color: #667eea; background: #e3f2fd; }

        .numeric-input {
            width: 200px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .results-container {
            display: none;
            padding: 30px;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .score-display {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .score-display h2 { font-size: 2.5rem; margin-bottom: 10px; }
        .hidden { display: none; }
        
        /* Difficulty badges */
        .difficulty-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }
        /* Results review styling */
.results-container h3 {
    color: #333;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
}

@media (max-width: 768px) {
    .results-container {
        padding: 15px;
    }
    
    .score-display {
        padding: 20px;
    }
    
    .score-display h2 {
        font-size: 2rem;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sequence, Limits and Continuity Quiz</h1>
            <p>Test your knowledge of sequences, limits and continuity with 50 comprehensive questions</p>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="quiz-container" style="display: none;">
            
            
            <div id="questionContainer"></div>
            
            <div class="question-navigation">
                <button class="btn-nav" id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
                <div class="question-status">
                    <span id="questionStatus">Question 1 of 50</span>
                    <span id="answeredStatus" class="status-unanswered">Unanswered</span>
                </div>
                <button class="btn-nav btn-next" id="nextBtn" onclick="nextQuestion()">Next</button>
            </div>
            
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #667eea;">
                <button class="btn" onclick="submitQuiz()" id="submitBtn">
                    <span id="submitText">Submit Sequence, Limits and Continuity Quiz</span>
                    <span id="submitLoading" class="loading" style="display: none;"></span>
                </button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="quiz-container" style="text-align: center; padding: 60px;">
            <div class="loading" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
            <h3>Loading Sequence, Limits and Continuity Quiz...</h3>
            <p>Verifying your session and preparing questions</p>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="results-container">
            <div class="score-display">
                <h2 id="finalScore">0/50</h2>
                <p>Quiz Completed Successfully!</p>
            </div>
            <button class="btn" onclick="goback()">Home Page</button>
        </div>
    </div>
   <!-- Anti-cheating warning overlay -->
    <div id="warningOverlay" class="warning-overlay">
        <div>
            <h2>CHEATING ATTEMPT DETECTED</h2>
            <p>Please return to the quiz window</p>
            <p>Your activity is being monitored</p>
        </div>
    </div>

  <script>
    // Answer validation utility
    let userAnswers = {};
    let currentUser = {};
    let username = null;
    let email = null;
    let currentQuestionIndex = 0;
    let quizStartTime = null;
    let questionStartTime = null;
    let questionTimes = {};
    let questions = [];
    let questionPoolSize = 0;
    let isInitialized = false; // Add flag to track initialization

    // Helper to normalize answers for better matching
    const answerNormalizer = {
        normalizeInterval: (answer) => {
            return (answer || '').toString().trim()
                .replace(/\s+/g, '')
                .replace(/\[/g, '[')
                .replace(/\]/g, ']')
                .replace(/\(/g, '(')
                .replace(/\)/g, ')')
                .toLowerCase();
        },
        
        normalizeCoordinate: (coord) => {
            return (coord || '').toString().trim()
                .replace(/\s+/g, '')
                .replace(/[()]/g, '')
                .toLowerCase();
        },
        
        normalizeEquation: (eq) => {
            return (eq || '').toString()
                .replace(/\s+/g, '')
                .replace(/\*\*/g, '^')
                .replace(/\^/g, '^')
                .replace(/\+\-/g, '-')
                .replace(/\-\+/g, '-')
                .replace(/log/gi, 'log')
                .replace(/ln/gi, 'ln')
                .toLowerCase();
        },
        
        normalizeNumeric: (num) => {
            const cleaned = (num || '').toString().replace(/[^\d.-]/g, '').trim();
            return cleaned ? parseFloat(cleaned) : NaN;
        }
    };

    // Enhanced Fisher-Yates shuffle with better randomness
    function enhancedShuffle(array) {
        if (!array || !Array.isArray(array)) return [];
        
        const shuffled = [...array];
        
        // Use crypto.getRandomValues if available for better randomness
        if (window.crypto && crypto.getRandomValues) {
            for (let i = shuffled.length - 1; i > 0; i--) {
                const randomBuffer = new Uint32Array(1);
                crypto.getRandomValues(randomBuffer);
                const j = Math.floor((randomBuffer[0] / 4294967296) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
        } else {
            // Fallback to enhanced Math.random with multiple passes
            for (let pass = 0; pass < 3; pass++) {
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
            }
        }
        
        return shuffled;
    }

    async function loadQuestions() {
        try {
            if (!email) {
                alert('Please login to take the assessment');
                return false;
            }
            
            console.log(`üéØ Loading fresh random questions for ${email}`);
            
            // Add timestamp and random seed to prevent caching and ensure uniqueness
            const timestamp = Date.now();
            const randomSeed = Math.random().toString(36).substring(2, 15);
            
            const response = await fetch(
                `https://sanghamitra-learnworld.vercel.app/api/iitm-math-questions/Function_Limits?` +
                `email=${encodeURIComponent(email)}&count=50&timestamp=${timestamp}&seed=${randomSeed}`, {
                credentials: 'include',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'X-No-Cache': timestamp.toString()
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to load questions: ${response.status}`);
            }
            
            const data = await response.json();
            questions = data.questions || data;
            
            if (!questions || questions.length === 0) {
                throw new Error('No questions available');
            }
            
            // Store pool size if provided by server
            if (data.totalQuestions) {
                questionPoolSize = data.totalQuestions;
                updatePoolInfo();
            }
            
            // Enhanced shuffle for better randomness
            questions = enhancedShuffle(questions);
            
            // Ensure exactly 50 questions
            if (questions.length > 50) {
                questions = questions.slice(0, 50);
            }
            
            console.log(`‚úÖ Loaded ${questions.length} fresh random questions`);
            console.log(`üìä From pool of ${questionPoolSize || 'unknown'} total questions`);
            
            return true;
            
        } catch (error) {
            console.error('Error loading questions:', error);
            alert('Failed to load quiz questions. Please refresh and try again.');
            return false;
        }
    }

    // Anti-cheating variables
    let cheatingAttempts = 0;
    let isQuizActive = false;
    let devToolsWarned = false;
    
    // Anti-cheating initialization
    function initializeAntiCheating() {
        // Disable right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            recordCheatingAttempt('right_click');
            return false;
        });
        
        // Disable common keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, Print Screen
            if (e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
                (e.ctrlKey && e.keyCode === 83) || // Ctrl+S
                e.keyCode === 44) { // Print Screen
                e.preventDefault();
                recordCheatingAttempt('keyboard_shortcut');
                return false;
            }
            
            // Disable Ctrl+A, Ctrl+C, Ctrl+V
            if (e.ctrlKey && (e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86)) {
                e.preventDefault();
                recordCheatingAttempt('copy_attempt');
                return false;
            }
        });
        
        // Detect developer tools
        let devtools = {open: false, orientation: null};
        const threshold = 160;
        
        setInterval(function() {
            if (window.outerHeight - window.innerHeight > threshold || 
                window.outerWidth - window.innerWidth > threshold) {
                if (!devtools.open) {
                    devtools.open = true;
                    recordCheatingAttempt('developer_tools');
                    if (!devToolsWarned) {
                        alert('Developer tools detected! This attempt has been logged.');
                        devToolsWarned = true;
                    }
                }
            } else {
                devtools.open = false;
            }
        }, 500);
        
        // Detect window focus changes
        window.addEventListener('blur', function() {
            if (isQuizActive) {
                document.body.classList.add('blurred');
                document.getElementById('warningOverlay').style.display = 'flex';
                recordCheatingAttempt('window_blur');
            }
        });
        
        window.addEventListener('focus', function() {
            document.body.classList.remove('blurred');
            document.getElementById('warningOverlay').style.display = 'none';
        });
        
        // Prevent text selection
        document.onselectstart = function() {
            recordCheatingAttempt('text_selection');
            return false;
        };
        
        // Disable drag
        document.ondragstart = function() {
            return false;
        };
        
        // Monitor for screenshot attempts
        document.addEventListener('keyup', function(e) {
            if (e.keyCode === 44) { // Print Screen released
                recordCheatingAttempt('screenshot_attempt');
                alert('Screenshot attempt detected and logged!');
            }
        });
    }
    
    // Record cheating attempts
    function recordCheatingAttempt(type) {
        cheatingAttempts++;
        console.warn(`Cheating attempt #${cheatingAttempts}: ${type}`);
        
        if (username && email) {
            fetch('https://sanghamitra-learnworld.vercel.app/api/log-cheating', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    username: username,
                    email: email,
                    cheatingType: type,
                    timestamp: new Date(),
                    currentQuestion: currentQuestionIndex + 1
                })
            }).catch(err => console.error('Failed to log cheating attempt:', err));
        }
        
        // Auto-submit quiz after too many attempts
        if (cheatingAttempts >= 5) {
            alert('Too many suspicious activities detected. Quiz will be auto-submitted.');
            submitQuiz();
        }
    }
    
    // Disable printing
    window.addEventListener('beforeprint', function(e) {
        recordCheatingAttempt('print_attempt');
        e.preventDefault();
        return false;
    });
    
    // Hide questions from view source
    function obfuscateQuestions() {
        Object.defineProperty(window, 'questions', {
            get: function() {
                recordCheatingAttempt('questions_access');
                return [];
            }
        });
    }
    
    // Initialize quiz timing
    function initializeQuizTiming() {
        quizStartTime = new Date();
        questionStartTime = new Date();
    }

    // Track question timing
    function trackQuestionTime() {
        if (questionStartTime) {
            const timeSpent = Math.floor((new Date() - questionStartTime) / 1000);
            questionTimes[currentQuestionIndex] = timeSpent;
        }
        questionStartTime = new Date(); // Reset for next question
    }

    // Fetch user session info
    async function fetchSessionInfo() {
        try {
            const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/session-info', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                username = data.username;
                email = data.email;
                console.log("User:", username, "Email:", email);
                return true;
            } else {
                console.error('Failed to fetch session info');
                alert('Please login to take the assessment');
                window.location.href = '/login.html';
                return false;
            }
        } catch (error) {
            console.error('Error fetching session info:', error);
            alert('Error connecting to server. Please try again.');
            return false;
        }
    }

    // Update question pool info display - SAFE VERSION
    function updatePoolInfo() {
        
        
        if (questionPoolSize > 0) {
            poolInfo.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           color: white; padding: 12px; border-radius: 10px; margin: 15px 0;
                           box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">üé≤</span>
                        <div>
                            <strong style="font-size: 14px;">Random Question Selection</strong>
                            <div style="font-size: 12px; opacity: 0.9;">
                                From pool of ${questionPoolSize} questions | 
                                50 random questions each attempt
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // SAFE DOM element access function
    function getElementSafely(id) {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`Element with id "${id}" not found`);
        }
        return element;
    }

    async function initializeQuiz() {
        try {
            // Check if already initialized
            if (isInitialized) {
                console.log('Quiz already initialized');
                return;
            }
            
            // Initialize anti-cheating first
            initializeAntiCheating();
            
            const sessionValid = await fetchSessionInfo();
            if (!sessionValid) return;
            
            // Show loading message - SAFE ACCESS
            const loadingText = getElementSafely('loadingText');
            if (loadingText) {
                loadingText.innerHTML = `
                    Loading fresh random questions...<br>
                    <small style="opacity: 0.8;">Each attempt gets 50 new random questions</small>
                `;
            }
            
            // Load fresh random questions
            const questionsLoaded = await loadQuestions();
            if (!questionsLoaded) return;
            
            currentUser = { username, email };
            
            // Initialize timing
            initializeQuizTiming();
            isQuizActive = true;
            
            // Hide loading screen and show quiz - SAFE ACCESS
            const loadingScreen = getElementSafely('loadingScreen');
            const quizContainer = getElementSafely('quizContainer');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (quizContainer) quizContainer.style.display = 'block';
            
            // Obfuscate questions
            obfuscateQuestions();
            
            renderCurrentQuestion();
            updateProgress();
            
            isInitialized = true;
            
        } catch (error) {
            console.error('Error initializing quiz:', error);
            alert('Error starting quiz. Please try again.');
        }
    }

    // Start a completely new random attempt
    async function startNewAttempt() {
        const confirmStart = confirm(
            "üöÄ Start New Quiz Attempt\n\n" +
            "‚Ä¢ You'll get 50 NEW random questions\n" +
            "‚Ä¢ Questions will be completely different\n" +
            "‚Ä¢ Previous answers will be cleared\n" +
            "‚Ä¢ Your progress will be saved separately\n\n" +
            "Start new quiz?"
        );
        
        if (!confirmStart) return;
        
        try {
            // Reset all quiz state
            userAnswers = {};
            currentQuestionIndex = 0;
            questionTimes = {};
            cheatingAttempts = 0;
            isQuizActive = false;
            isInitialized = false;
            
            // Show loading screen - SAFE ACCESS
            const quizContainer = getElementSafely('quizContainer');
            const resultsContainer = getElementSafely('resultsContainer');
            const loadingScreen = getElementSafely('loadingScreen');
            const loadingText = getElementSafely('loadingText');
            
            if (quizContainer) quizContainer.style.display = 'none';
            if (resultsContainer) resultsContainer.style.display = 'none';
            if (loadingScreen) loadingScreen.style.display = 'flex';
            if (loadingText) {
                loadingText.innerHTML = `
                    Loading new random questions...<br>
                    <small style="opacity: 0.8;">Shuffling question pool...</small>
                `;
            }
            
            // Clear any cached data
            if (window.localStorage) {
                localStorage.removeItem('quiz_cache');
            }
            
            // Load fresh random questions
            await new Promise(resolve => setTimeout(resolve, 500)); // Small delay for UX
            
            const questionsLoaded = await loadQuestions();
            if (!questionsLoaded) {
                alert('Failed to load new questions. Please try again.');
                return;
            }
            
            // Re-initialize quiz
            initializeQuizTiming();
            isQuizActive = true;
            
            // Hide loading and show quiz - SAFE ACCESS
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (quizContainer) quizContainer.style.display = 'block';
            
            renderCurrentQuestion();
            updateProgress();
            
            // Show success message
            showNotification('üé≤ New quiz started with 50 random questions!');
            
            isInitialized = true;
            
        } catch (error) {
            console.error('Error starting new attempt:', error);
            alert('Error starting new quiz. Please refresh the page.');
        }
    }

    // Show notification
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        `;
        notification.innerHTML = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
        
        // Add CSS animations if not present
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Render current question
    function renderCurrentQuestion() {
        const container = document.getElementById('questionContainer');
        if (!container || !questions || !questions[currentQuestionIndex]) {
            console.error('Cannot render question: container or questions not available');
            return;
        }
        
        const question = questions[currentQuestionIndex];
        container.innerHTML = '';

        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-card';

        let optionsHtml = '';
        
        if (question.type === 'multiple_choice' && question.options && question.options.length > 0) {
            optionsHtml = question.options.map((option, optIndex) => {
                const safeOption = String(option).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return `
                    <div class="option" onclick="selectOption(${currentQuestionIndex}, '${safeOption}', 'radio', event)">
                        <input type="radio" name="q${currentQuestionIndex}" value="${safeOption}" id="q${currentQuestionIndex}_${optIndex}">
                        <label for="q${currentQuestionIndex}_${optIndex}">${option}</label>
                    </div>
                `;
            }).join('');
        } else if (question.type === 'multiple_select' && question.options && question.options.length > 0) {
            optionsHtml = question.options.map((option, optIndex) => {
                const safeOption = String(option).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return `
                    <div class="option" onclick="selectOption(${currentQuestionIndex}, '${safeOption}', 'checkbox', event)">
                        <input type="checkbox" name="q${currentQuestionIndex}" value="${safeOption}" id="q${currentQuestionIndex}_${optIndex}">
                        <label for="q${currentQuestionIndex}_${optIndex}">${option}</label>
                    </div>
                `;
            }).join('');
        } else if (['numeric', 'interval_input', 'numeric_input', 'coordinate_input', 'equation_input', 'text_input'].includes(question.type)) {
            let placeholder, formatExample, formatHint;
            
            if (question.type === 'coordinate_input') {
                placeholder = "e.g., (3, 4) or (3,4)";
                formatExample = "(x, y)";
                formatHint = "‚úì Accepted: (3,4) or (3, 4) | ‚úó Avoid: 3,4 or [3,4]";
            } else if (question.type === 'equation_input') {
                placeholder = "e.g., y = log(x) + 2";
                formatExample = "equation with =";
                formatHint = "‚úì Accepted: y=log(x)+2 or y = log(x) + 2 | Use log for logarithms";
            } else if (question.type === 'interval_input') {
                placeholder = "e.g., (0, ‚àû) or [1, 10]";
                formatExample = "[a,b] or (a,b)";
                formatHint = "‚úì Use [ ] for inclusive, ( ) for exclusive | Use 'inf' or ‚àû for infinity";
            } else if (question.type === 'numeric' || question.type === 'numeric_input') {
                placeholder = "e.g., 42 or -3.14 or 2.718";
                formatExample = "number";
                formatHint = "‚úì Accepted: 42, -3.14, 0.5 | Decimals are fine";
            } else {
                placeholder = question.format_hint || "Enter your answer";
                formatExample = "text";
                formatHint = question.format_hint || "";
            }
            
            optionsHtml = `
                <div style="background: #f0f8ff; border: 2px dashed #667eea; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 18px;">üìù</span>
                        <strong style="color: #667eea;">Format Required: ${formatExample}</strong>
                    </div>
                    <div style="font-size: 13px; color: #666; line-height: 1.5;">
                        ${formatHint}
                    </div>
                </div>
                <input type="text" 
                       class="numeric-input" 
                       placeholder="${placeholder}" 
                       onchange="handleNumericInputWithValidation(${currentQuestionIndex}, this.value)"
                       oninput="handleNumericInput(${currentQuestionIndex}, this.value)"
                       autocomplete="off"
                       spellcheck="false"
                       style="width: 100%; max-width: 300px; font-size: 16px; font-family: 'Courier New', monospace;">
                <div id="feedback-${currentQuestionIndex}" style="margin-top: 10px; min-height: 24px;"></div>
            `;
        } else {
            optionsHtml = `
                <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px;">
                    <strong>Error:</strong> Unable to display question options.
                </div>
            `;
        }

        const difficultyColor = {
            'easy': '#28a745',
            'medium': '#ffc107', 
            'hard': '#dc3545'
        };
        
        const difficulty = question.difficulty || 'medium';
        const difficultyText = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);

        // Process question text for LaTeX
        let processedQuestionText = question.question_text || 'Question text not available';
        
        // Wrap LaTeX expressions
        processedQuestionText = processedQuestionText
            .replace(/\\lim_\{([^}]+)\}/g, '\\\\(\\\\lim_{$1}\\\\)')
            .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '\\\\(\\\\frac{$1}{$2}\\\\)')
            .replace(/\\sqrt\{([^}]+)\}/g, '\\\\(\\\\sqrt{$1}\\\\)')
            .replace(/\\to/g, '\\\\(\\\\to\\\\)')
            .replace(/\\infty/g, '\\\\(\\\\infty\\\\)');

        // Add randomization indicator
        const randomIndicator = `
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px; font-size: 12px; color: #667eea;">
                <span>üé≤</span>
                <span>Random Question #${currentQuestionIndex + 1}</span>
            </div>
        `;

        questionDiv.innerHTML = `
        <div class="question-header">
            <div class="question-number">${currentQuestionIndex + 1}</div> <!-- ADD THIS LINE -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="background: ${difficultyColor[difficulty]}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase;">
                    ${difficultyText}
                </span>
            </div>
        </div>
        ${randomIndicator}
        <div class="question-text" id="question-text-${currentQuestionIndex}">${processedQuestionText}</div>
        <div class="options">${optionsHtml}</div>
`;

        container.appendChild(questionDiv);
        
        // Process MathJax
        setTimeout(() => {
            if (window.MathJax) {
                window.MathJax.typesetPromise([questionDiv]).catch(err => {
                    console.log('MathJax typeset error:', err);
                });
            }
        }, 100);
        
        // Restore previous answer if exists
        restoreAnswer();
        updateAnswerStatus();
    }

    function restoreAnswer() {
        if (!questions || !questions[currentQuestionIndex]) return;
        
        const question = questions[currentQuestionIndex];
        const savedAnswer = userAnswers[currentQuestionIndex];
        
        if (!savedAnswer) return;

        if (question.type === 'multiple_choice') {
            const option = document.querySelector(`input[value="${savedAnswer}"]`);
            if (option) {
                option.checked = true;
                option.closest('.option').classList.add('selected');
            }
        } else if (question.type === 'multiple_select' && Array.isArray(savedAnswer)) {
            savedAnswer.forEach(answer => {
                const option = document.querySelector(`input[value="${answer}"]`);
                if (option) {
                    option.checked = true;
                    option.closest('.option').classList.add('selected');
                }
            });
        } else if (question.type === 'numeric' || question.type === 'interval_input' || question.type === 'numeric_input' || question.type === 'coordinate_input' || question.type === 'equation_input' || question.type === 'text_input') {
            const input = document.querySelector('.numeric-input');
            if (input) {
                input.value = savedAnswer;
            }
        }
    }

    function updateProgress() {
        if (!questions || questions.length === 0) return;
        
        
        if (questionStatus) questionStatus.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        
        // Update navigation buttons
        if (prevBtn) prevBtn.disabled = currentQuestionIndex === 0;
        
        if (nextBtn) {
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.textContent = 'Finish';
                nextBtn.onclick = () => {
                    const quizContainer = getElementSafely('quizContainer');
                    if (quizContainer) {
                        quizContainer.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'end' 
                        });
                    }
                };
            } else {
                nextBtn.textContent = 'Next';
                nextBtn.onclick = nextQuestion;
            }
        }
    }

    function updateAnswerStatus() {
        const statusSpan = document.getElementById('answeredStatus');
        if (!statusSpan) return;
        
        const hasAnswer = userAnswers[currentQuestionIndex] !== undefined;
        
        if (hasAnswer) {
            statusSpan.textContent = 'Answered';
            statusSpan.className = 'status-answered';
        } else {
            statusSpan.textContent = 'Unanswered';
            statusSpan.className = 'status-unanswered';
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            trackQuestionTime();
            currentQuestionIndex++;
            renderCurrentQuestion();
            updateProgress();
        }
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            trackQuestionTime();
            currentQuestionIndex--;
            renderCurrentQuestion();
            updateProgress();
        }
    }

   function selectOption(questionIndex, value, type, event) {
    if (type === 'radio') {
        userAnswers[questionIndex] = value.trim();
        // Remove 'selected' class from all options AND uncheck all radio buttons
        const options = document.querySelectorAll(`input[name="q${questionIndex}"]`);
        options.forEach(opt => {
            opt.closest('.option').classList.remove('selected');
            opt.checked = false;
        });
        // Find the clicked option - handle clicks on div, input, or label
        const clickedOption = event.target.closest('.option');
        const clickedInput = clickedOption.querySelector('input');
        clickedInput.checked = true;
        clickedOption.classList.add('selected');
        } else if (type === 'checkbox') {
            if (!userAnswers[questionIndex]) userAnswers[questionIndex] = [];
            
            const checkbox = event.target.closest('.option').querySelector('input');
            if (checkbox.checked) {
                if (!userAnswers[questionIndex].includes(value.trim())) {
                    userAnswers[questionIndex].push(value.trim());
                }
                event.target.closest('.option').classList.add('selected');
            } else {
                userAnswers[questionIndex] = userAnswers[questionIndex].filter(ans => ans !== value.trim());
                event.target.closest('.option').classList.remove('selected');
                
                if (userAnswers[questionIndex].length === 0) {
                    delete userAnswers[questionIndex];
                }
            }
        }
        updateAnswerStatus();
    }

    function handleNumericInput(questionIndex, value) {
        if (!questions || !questions[questionIndex]) return;
        
        const question = questions[questionIndex];
        
        if (question.type === 'coordinate_input') {
            const trimmedValue = value.trim();
            if (trimmedValue) {
                if (trimmedValue.includes(',') && !trimmedValue.includes('(')) {
                    userAnswers[questionIndex] = `(${trimmedValue})`;
                } else {
                    userAnswers[questionIndex] = trimmedValue;
                }
            } else {
                delete userAnswers[questionIndex];
            }
        } else if (question.type === 'equation_input') {
            const trimmedValue = value.trim();
            if (trimmedValue) {
                userAnswers[questionIndex] = trimmedValue;
            } else {
                delete userAnswers[questionIndex];
            }
        } else if (question.type === 'numeric' || question.type === 'numeric_input') {
            const cleanValue = value.replace(/[^\d.-]/g, '').trim();
            if (cleanValue && !isNaN(parseFloat(cleanValue))) {
                userAnswers[questionIndex] = cleanValue;
            } else if (value.trim() === '') {
                delete userAnswers[questionIndex];
            }
        } else {
            const trimmedValue = value.trim();
            if (trimmedValue) {
                userAnswers[questionIndex] = trimmedValue;
            } else {
                delete userAnswers[questionIndex];
            }
        }
        
        updateAnswerStatus();
    }

    function validateAnswerFormat(questionIndex, userAnswer) {
        if (!questions || !questions[currentQuestionIndex]) {
            return { isValidFormat: false, feedback: 'Question not available', suggestion: '' };
        }
        
        const question = questions[currentQuestionIndex];
        let feedback = '';
        let isValidFormat = true;
        let suggestion = '';
        
        if (question.type === 'coordinate_input') {
            const coordPattern = /^\s*\(\s*-?[\d.]+\s*,\s*-?[\d.]+\s*\)\s*$/;
            if (!coordPattern.test(userAnswer)) {
                feedback = 'Invalid format';
                suggestion = 'Use format: (x, y) with numbers. Example: (3, 4) or (-2.5, 1.3)';
                isValidFormat = false;
            } else {
                feedback = '‚úì Format correct';
                suggestion = '';
            }
        } else if (question.type === 'equation_input') {
            if (!userAnswer.includes('=')) {
                feedback = 'Missing equals sign';
                suggestion = 'Equation must contain =. Example: y = log(x) + 2 or y = ln(x)';
                isValidFormat = false;
            } else {
                feedback = '‚úì Format correct';
                suggestion = '';
            }
        } else if (question.type === 'numeric' || question.type === 'numeric_input') {
            const numValue = parseFloat(userAnswer.replace(/[^\d.-]/g, ''));
            if (isNaN(numValue)) {
                feedback = 'Invalid number';
                suggestion = 'Enter a valid number. Examples: 42, -3.14, 0.5, 2.718';
                isValidFormat = false;
            } else {
                feedback = '‚úì Valid number';
                suggestion = '';
            }
        } else if (question.type === 'interval_input') {
            const intervalPattern = /^[\[\(]\s*-?[\d.]+\s*,\s*-?[\d.]+\s*[\]\)]$/;
            const infinityPattern = /^[\[\(]\s*-?[\d.]+\s*,\s*(inf|‚àû|infinity)\s*[\]\)]$/i;
            const negInfinityPattern = /^[\[\(]\s*(-inf|-‚àû|-infinity)\s*,\s*-?[\d.]+\s*[\]\)]$/i;
            
            if (!intervalPattern.test(userAnswer) && !infinityPattern.test(userAnswer) && !negInfinityPattern.test(userAnswer)) {
                feedback = 'Invalid interval format';
                suggestion = 'Use: [a,b] for inclusive or (a,b) for exclusive. Example: (0, ‚àû) or [1, 10]. Use "inf" or ‚àû for infinity';
                isValidFormat = false;
            } else {
                feedback = '‚úì Format correct';
                suggestion = '';
            }
        }
        
        return { isValidFormat, feedback, suggestion };
    }

    function showValidationFeedback(questionIndex, feedback, suggestion) {
        const feedbackDiv = document.getElementById(`feedback-${questionIndex}`);
        if (!feedbackDiv) return;
        
        if (!feedback) {
            feedbackDiv.innerHTML = '';
            return;
        }
        
        const isValid = feedback.includes('‚úì');
        feedbackDiv.style.cssText = `
            background: ${isValid ? '#d4edda' : '#fff3cd'};
            border: 1px solid ${isValid ? '#c3e6cb' : '#ffeaa7'};
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.5;
        `;
        
        feedbackDiv.innerHTML = `
            <div style="color: ${isValid ? '#155724' : '#856404'}; font-weight: 600; margin-bottom: 4px;">
                ${feedback}
            </div>
            ${suggestion ? `<div style="color: #666; font-size: 13px;">${suggestion}</div>` : ''}
        `;
    }

    function handleNumericInputWithValidation(questionIndex, value) {
        handleNumericInput(questionIndex, value);
        
        if (value.trim()) {
            const validation = validateAnswerFormat(questionIndex, value.trim());
            showValidationFeedback(questionIndex, validation.feedback, validation.suggestion);
        } else {
            showValidationFeedback(questionIndex, '', '');
        }
    }

    async function submitQuiz() {
        const confirmSubmit = confirm(`Ready to Submit?\n\nPlease make sure you have reviewed all your answers before submitting.\nOnce submitted, you won't be able to make changes.\n\nAre you ready to submit your Sequence, Limits and Continuity Quiz?`);
        
        if (!confirmSubmit) {
            return;
        }
    
        if (!username || !email) {
            alert("Error: User session data not found. Please log in.");
            return;
        }

        trackQuestionTime();
        isQuizActive = false;
        const quizEndTime = new Date();
        const totalTimeTaken = Math.floor((quizEndTime - quizStartTime) / 1000);

        let score = 0;
        let totalPossiblePoints = 0;
        const questionResults = [];
        const difficultyBreakdown = {
            easy: { attempted: 0, correct: 0, points: 0 },
            medium: { attempted: 0, correct: 0, points: 0 },
            hard: { attempted: 0, correct: 0, points: 0 }
        };
        
        if (!questions || questions.length === 0) {
            alert('No questions data available');
            return;
        }
        
        questions.forEach((question, index) => {
            const userAnswer = userAnswers[index];
            totalPossiblePoints += question.points;
            
            let isCorrect = false;
            
            if (question.type === 'interval_input') {
                const normalizeInterval = answerNormalizer.normalizeInterval;
                let normalizedUser = normalizeInterval(userAnswer);
                let normalizedCorrect = normalizeInterval(question.correct_answer);
                
                normalizedUser = normalizedUser.replace(/inf|‚àû|infinity/gi, 'inf');
                normalizedCorrect = normalizedCorrect.replace(/inf|‚àû|infinity/gi, 'inf');
                
                isCorrect = normalizedUser === normalizedCorrect;
                
                if (!isCorrect && question.alternative_answers && Array.isArray(question.alternative_answers)) {
                    isCorrect = question.alternative_answers.some(alt => {
                        let normalizedAlt = normalizeInterval(alt).replace(/inf|‚àû|infinity/gi, 'inf');
                        return normalizedAlt === normalizedUser;
                    });
                }
            } else if (question.type === 'multiple_choice') {
                const normalizeAnswer = (answer) => (answer || '').toString().trim().toLowerCase();
                isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(question.correct_answer);
            } else if (question.type === 'multiple_select') {
                if (Array.isArray(userAnswer) && Array.isArray(question.correct_answer)) {
                    const normalizeArray = (arr) => arr.map(item => item.toString().trim().toLowerCase()).sort();
                    const userNorm = normalizeArray(userAnswer);
                    const correctNorm = normalizeArray(question.correct_answer);
                    isCorrect = userNorm.length === correctNorm.length &&
                               userNorm.every((ans, idx) => ans === correctNorm[idx]);
                }
            } else if (question.type === 'numeric' || question.type === 'numeric_input') {
                const userNum = answerNormalizer.normalizeNumeric(userAnswer);
                const correctNum = answerNormalizer.normalizeNumeric(question.correct_answer);
                if (!isNaN(userNum) && !isNaN(correctNum)) {
                    const tolerance = Math.max(Math.abs(correctNum) * 0.01, 0.01);
                    isCorrect = Math.abs(userNum - correctNum) <= tolerance;
                }
            } else if (question.type === 'coordinate_input') {
                const normalizeCoord = answerNormalizer.normalizeCoordinate;
                isCorrect = normalizeCoord(userAnswer) === normalizeCoord(question.correct_answer);
            } else if (question.type === 'equation_input') {
                const normalizeEq = answerNormalizer.normalizeEquation;
                isCorrect = normalizeEq(userAnswer) === normalizeEq(question.correct_answer);
                
                if (!isCorrect && question.alternative_answers && Array.isArray(question.alternative_answers)) {
                    isCorrect = question.alternative_answers.some(alt => 
                        normalizeEq(alt) === normalizeEq(userAnswer)
                    );
                }
            } else {
                const normalizeText = (text) => (text || '').toString().trim().toLowerCase();
                isCorrect = normalizeText(userAnswer) === normalizeText(question.correct_answer);
            }
            
            if (isCorrect) {
                score += question.points;
            }
            
            difficultyBreakdown[question.difficulty].attempted++;
            if (isCorrect) {
                difficultyBreakdown[question.difficulty].correct++;
                difficultyBreakdown[question.difficulty].points += question.points;
            }
            
            questionResults.push({
                questionId: question._id,
                questionNumber: question.question_number,
                questionText: question.question_text,
                difficulty: question.difficulty,
                points: question.points,
                userAnswer: userAnswer ? userAnswer.toString() : 'No answer provided',
                correctAnswer: question.correct_answer.toString(),
                explanation: question.explanation || '',
                isCorrect: isCorrect,
                timeTaken: questionTimes[index] || 0
            });
        });

        const quizData = {
            topic: 'Function_Limits',
            quizType: 'practice',
            score: score,
            maxPossibleScore: totalPossiblePoints,
            totalQuestions: questions.length,
            correctAnswers: questionResults.filter(q => q.isCorrect).length,
            percentage: Math.round((score / totalPossiblePoints) * 100),
            difficultyBreakdown: difficultyBreakdown,
            questionResults: questionResults,
            startTime: quizStartTime,
            endTime: quizEndTime,
            totalTimeTaken: totalTimeTaken,
            isCompleted: true,
            randomizationInfo: {
                poolSize: questionPoolSize,
                timestamp: quizStartTime,
                isRandomized: true
            }
        };

        try {
            const submitText = getElementSafely('submitText');
            const submitLoading = getElementSafely('submitLoading');
            const submitBtn = getElementSafely('submitBtn');
            
            if (submitText) submitText.style.display = 'none';
            if (submitLoading) submitLoading.style.display = 'inline-block';
            if (submitBtn) submitBtn.disabled = true;

            console.log('Submitting quiz data:', {
                email: email,
                username: username,
                quizData: quizData
            });
            
            const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/iitmmath_scores', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    email: email,
                    username: username,
                    quizData: quizData
                })
            });

            if (response.ok) {
                console.log('Quiz submitted successfully');
                displayDetailedResults(quizData);
                
                // Add retake button to results
                const resultsContainer = getElementSafely('resultsContainer');
                if (resultsContainer) {
                    const retakeSection = document.createElement('div');
                    retakeSection.style.cssText = `
                        text-align: center;
                        margin: 30px 0;
                        padding: 20px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 15px;
                        color: white;
                    `;
                    retakeSection.innerHTML = `
                        <h3 style="margin-bottom: 15px;">üé≤ Want to try another random set?</h3>
                        <p style="margin-bottom: 20px; opacity: 0.9;">
                            Each retake gives you 50 NEW random questions from the pool of ${questionPoolSize || 'many'} questions
                        </p>
                        <button onclick="startNewAttempt()" style="
                            background: white;
                            color: #667eea;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            font-size: 16px;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            transition: transform 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'" 
                           onmouseout="this.style.transform='translateY(0)'">
                            üîÑ Retake with New Random Questions
                        </button>
                    `;
                    
                    resultsContainer.appendChild(retakeSection);
                }
                
            } else {
                const errorText = await response.text();
                console.error('Failed to submit quiz:', errorText);
                alert('Failed to submit quiz. Please try again.');
                
                if (submitText) submitText.style.display = 'inline';
                if (submitLoading) submitLoading.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
                return;
            }
        } catch (error) {
            console.error('Error submitting quiz:', error);
            alert('Error submitting quiz. Please check your connection and try again.');
            
            const submitText = getElementSafely('submitText');
            const submitLoading = getElementSafely('submitLoading');
            const submitBtn = getElementSafely('submitBtn');
            
            if (submitText) submitText.style.display = 'inline';
            if (submitLoading) submitLoading.style.display = 'none';
            if (submitBtn) submitBtn.disabled = false;
            return;
        }
    }

    function displayDetailedResults(quizData) {
        const quizContainer = getElementSafely('quizContainer');
        const resultsContainer = getElementSafely('resultsContainer');
        
        if (quizContainer) quizContainer.style.display = 'none';
        if (resultsContainer) resultsContainer.style.display = 'block';
        
        const scoreDisplay = document.querySelector('.score-display');
        if (scoreDisplay) {
            scoreDisplay.innerHTML = `
                <h2>${quizData.score}/${quizData.maxPossibleScore} Points (${quizData.percentage}%)</h2>
                <p>Quiz Completed Successfully!</p>
                <div style="margin-top: 20px; display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <strong>Easy Questions</strong><br>
                        ${quizData.difficultyBreakdown.easy.correct}/${quizData.difficultyBreakdown.easy.attempted}
                    </div>
                    <div>
                        <strong>Medium Questions</strong><br>
                        ${quizData.difficultyBreakdown.medium.correct}/${quizData.difficultyBreakdown.medium.attempted}
                    </div>
                    <div>
                        <strong>Hard Questions</strong><br>
                        ${quizData.difficultyBreakdown.hard.correct}/${quizData.difficultyBreakdown.hard.attempted}
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    Time Taken: ${Math.floor(quizData.totalTimeTaken / 60)}m ${quizData.totalTimeTaken % 60}s
                </p>
                ${questionPoolSize > 0 ? `
                    <p style="margin-top: 10px; font-size: 0.9em; color: #667eea;">
                        üìä Questions selected randomly from pool of ${questionPoolSize} questions
                    </p>
                ` : ''}
            `;
        }
        
        if (resultsContainer) {
            const reviewDiv = document.createElement('div');
            reviewDiv.style.cssText = `
                margin-top: 30px;
                text-align: left;
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            `;
            
            reviewDiv.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 25px; color: #333;">Question Review</h3>
                ${quizData.questionResults.map((result, index) => `
                    <div style="border: 2px solid ${result.isCorrect ? '#28a745' : '#dc3545'}; 
                                border-radius: 8px; 
                                padding: 15px; 
                                margin-bottom: 15px; 
                                background: ${result.isCorrect ? '#f8fff9' : '#fff8f8'};">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="background: ${result.isCorrect ? '#28a745' : '#dc3545'}; 
                                        color: white; 
                                        padding: 4px 8px; 
                                        border-radius: 50%; 
                                        margin-right: 10px; 
                                        font-weight: bold;">
                               ${result.questionNumber || index + 1}
                            </span>
                            <span style="font-weight: bold; color: ${result.isCorrect ? '#28a745' : '#dc3545'};">
                                ${result.isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                            </span>
                            <span style="margin-left: auto; font-size: 12px; color: #666;">
                                ${result.difficulty.toUpperCase()}
                            </span>
                        </div>
                        <div style="margin-bottom: 10px; line-height: 1.4;">
                            <strong>Question:</strong> ${result.questionText}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Your Answer:</strong> 
                            <span style="color: ${result.isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                ${result.userAnswer || 'No answer provided'}
                            </span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Correct Answer:</strong> 
                        <span style="color: #28a745; font-weight: bold;">
                            ${result.correctAnswer}
                        </span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Explanation:</strong> 
                        <span style="color: #28a745; font-weight: bold;">
                            ${result.explanation}
                        </span>
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        Time taken: ${result.timeTaken}s
                    </div>
                </div>
            `).join('')}
        `;
        
        resultsContainer.appendChild(reviewDiv);
        }
    }

    // Add CSS for pool info section
    function addPoolInfoStyles() {
        if (!document.getElementById('pool-styles')) {
            const style = document.createElement('style');
            style.id = 'pool-styles';
            style.textContent = `
                #poolInfo {
                    animation: fadeIn 0.5s ease;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Initialize when DOM is ready
    function setupQuiz() {
        addPoolInfoStyles();
        
        // Create pool info container if not exists
        if (!document.getElementById('poolInfo')) {
            const poolContainer = document.createElement('div');
            poolContainer.id = 'poolInfo';
            
            // Try to find a safe place to insert it
            const quizHeader = document.querySelector('.quiz-header');
            if (quizHeader) {
                quizHeader.insertBefore(poolContainer, quizHeader.firstChild);
            } else {
                // If .quiz-header doesn't exist, append to body
                document.body.insertBefore(poolContainer, document.body.firstChild);
            }
        }
        
        // Initialize quiz
        initializeQuiz();
    }

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', setupQuiz);

    // Fallback initialization for pages already loaded
    if (document.readyState === 'interactive' || document.readyState === 'complete') {
        setTimeout(setupQuiz, 100); // Small delay to ensure everything is ready
    }

    function goback() {
        userAnswers = {};
        questionTimes = {};
        window.location.href = 'iitm_math.html';
    }
</script>
</body>

</html>







