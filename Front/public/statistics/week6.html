router.get('/iitm-stats-questions/week6', async (req, res) => {
  try {
    const { email, count = 50 } = req.query;
    
    if (!email) {
      return res.status(400).json({ 
        error: 'Email is required to track question history' 
      });
    }

    console.log(`Fetching Week 6 statistics questions for: ${email}`);
    
    // Find user's completed questions
    let userScore = await Statistics_scores.findOne({ email });
    const completedQuestionIds = userScore?.completedQuestionIds || [];
    
    console.log(`User ${email} has completed ${completedQuestionIds.length} statistics questions`);

    // Find all available Week 6 questions excluding completed ones
    let availableQuestions = await Statistics_questions.find({
      topic: "Permutations and Combinations",
      _id: { $nin: completedQuestionIds }
    });

    console.log(`Found ${availableQuestions.length} new statistics Week 6 questions available`);

    // Handle case where user has completed all questions
    if (availableQuestions.length === 0) {
      const totalInPool = await Statistics_questions.countDocuments({ topic: "Permutations and Combinations" });
      return res.status(200).json({
        message: "All Week 6 questions completed",
        questions: [],
        resetAvailable: true,
        totalQuestionsInPool: totalInPool
      });
    }

    // Select requested number of questions
    const questionsToReturn = Math.min(parseInt(count), availableQuestions.length);
    
    // Randomly shuffle and select questions
    const shuffled = availableQuestions.sort(() => 0.5 - Math.random());
    const selectedQuestions = shuffled.slice(0, questionsToReturn);
    
    // Sort selected questions by question_number for consistent display
    selectedQuestions.sort((a, b) => a.question_number - b.question_number);

    console.log(`Returning ${selectedQuestions.length} random statistics questions for Week 6`);

    res.json({
      questions: selectedQuestions,
      metadata: {
        totalAvailable: availableQuestions.length,
        totalCompleted: completedQuestionIds.length,
        selectedCount: selectedQuestions.length,
        requestedCount: parseInt(count)
      }
    });

  } catch (error) {
    console.error('Error fetching statistics Week 6 questions:', error);
    res.status(500).json({ 
      error: 'Failed to fetch Week 6 statistics questions',
      details: error.message 
    });
  }
});