<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Statistics</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="../assets/img/favicon.png" rel="icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">

  <style>
    .course-list {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 15px;
    }

    .course-item {
      margin-bottom: 2rem !important;
    }

    .course-card {
      max-width: 100%;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .course-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .icon-box {
      width: 40px !important;
      height: 40px !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress {
      height: 6px !important;
      background-color: #f0f0f0;
    }

    .fs-7 {
      font-size: 0.85rem !important;
    }

    .course-card .btn {
      min-width: 120px;
      padding: 0.4rem 1rem;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
    }

    .percentage-badge {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      box-shadow: 0 2px 4px rgba(0,123,255,0.3);
    }

    .completed-badge {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(40,167,69,0.3);
      display: inline-flex;
      align-items: center;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .error-message {
      color: #dc3545;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="index.html" class="logo d-flex align-items-center me-auto">
        <img src="../img/sbi.logo.png" alt="Logo" width="80" height="80">
        <h1 class="">Sanghamitra Learning</h1>
      </a>
      <nav id="navmenu" class="navmenu">
        <div id="navbar-placeholder"></div>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main class="main">
    <!-- Page Title -->
    <div class="page-title" data-aos="fade" style="margin-bottom: 2rem;">
      <div class="heading">
        <div class="container">
          <div class="row d-flex justify-content-center text-center">
            <div class="col-lg-8">
              <h1>Statistics</h1>
              <p class="mb-0">rom basic concepts to advanced statistical techniques, we guide you every step of the way. Join our community and begin your journey toward mastering the art of data analysis and decision-making through statistics.</p>
            </div>
          </div>
        </div>
      </div>
      <nav class="breadcrumbs">
        <div class="container">
          <ol>
            <li><a href="../index.html">Home</a></li>
            <li class="../current">Statistics</li>
          </ol>
        </div>
      </nav>
    </div><!-- End Page Title -->

    <main id="main" class="main">
      <div class="container">
        <div class="course-list" id="courseList">
          <!-- Loading message -->
          <div id="loadingMessage" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading course data...</p>
          </div>
          
          <!-- Error message -->
          <div id="errorMessage" class="alert alert-danger d-none">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="errorText">Failed to load course data. Please try refreshing the page.</span>
          </div>

          <!-- Course items will be dynamically generated here -->
        </div>
      </div>
    </main>
  </main>

  <footer id="footer" class="footer position-relative">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="../index.html" class="logo d-flex align-items-center">
            <span class="">Sanghamitra Learning</span>
          </a>
          <div class="footer-contact pt-3">
            <p>GacchiBowli</p>
            <p>Hyderabad, TS 500032</p>
            <p class="mt-3"><strong>Phone:</strong> <span>+91 7020102729</span></p>
            <p><strong>Email:</strong> <span>sanghamitra.learnworlds@gmail.com</span></p>
          </div>
          <div class="social-links d-flex mt-4">
            <a href=""><i class="bi bi-twitter"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href=""><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>

        <div class="col-lg-4 col-md-12 footer-newsletter">
        </div>
      </div>
    </div>

    <div class="container copyright text-center mt-4">
      <p>Â© <span>Copyright</span> <strong class="px-1">Sanghamitra Learning</strong> <span>All Rights Reserved</span></p>
      <div class="credits">
        Designed by <a href="../index.html">Sanghamitra</a>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Main JS File -->
  <script src="../assets/js/main.js"></script>
  <script src="../navbar.js"></script>
  
  <!-- Script to fetch and display course data from API -->
  <script>
    let currentUser = null;

    // Available topics configuration
    const availableTopics = [
    {
        id: 'Quiz1',
        name: 'Quiz1',  // This should match the topic field in your database
        displayName: 'IITM Statistics Quiz 1',
        description: 'Assessment on IITM first four weeks of statistics.',
        icon: 'bi-cpu',
        url: 'quiz1.html'
    },
    {
        id: 'week1',
        name: 'week1',  // This should match the topic field in your database
        displayName: 'Basics Of Data',
        description: 'Assessment on IITM first week of statistics.',
        icon: 'bi-cpu',
        url: 'week1.html'
    }
    // Add more topics here as needed
    ];

    // Initialize the application
    async function initializeApp() {
    try {
        showLoading(true);
        await fetchSessionInfo();
        await loadCourseData();
    } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize the application. Please try refreshing the page.');
    } finally {
        showLoading(false);
    }
    }

    // Fetch user session information
    async function fetchSessionInfo() {
    try {
        const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/session-info', {
        credentials: 'include'
        });

        if (!response.ok) {
        throw new Error('Session expired or invalid');
        }
        
        const data = await response.json();
        currentUser = {
        email: data.email,
        username: data.username
        };
        
        console.log('Session info fetched:', currentUser);
    } catch (error) {
        console.error('Session error:', error);
        // Uncomment the line below if you want to redirect to login
        // window.location.href = 'user_login.html';
        // For now, we'll continue without user data for testing
        currentUser = { email: 'test@example.com', username: 'Test User' };
    }
    }

    // Load course data from API
    async function loadCourseData() {
    try {
        if (!currentUser) {
        console.warn('No user session found');
        renderCourses(null);
        return;
        }

        const response = await fetch(
        `https://sanghamitra-learnworld.vercel.app/api/statistics_scores?email=${currentUser.email}`,
        { credentials: 'include' }
        );

        let userScoreData = null;
        if (response.ok) {
        const apiResponse = await response.json();
        console.log('API Response:', apiResponse);
        
        // Check if we have data and extract the user score data
        if (apiResponse.success && apiResponse.data) {
            userScoreData = apiResponse.data;
            console.log('User score data:', userScoreData);
        }
        } else {
        console.warn('No assessment data found or API error');
        }

        renderCourses(userScoreData);
        
    } catch (error) {
        console.error('Failed to load course data:', error);
        showError('Failed to load course data. Please try again.');
        renderCourses(null);
    }
    }

    // Render courses based on available topics and assessment data
    function renderCourses(userScoreData) {
    const courseList = document.getElementById('courseList');
    courseList.innerHTML = '';

    availableTopics.forEach(topic => {
        const topicAssessment = findTopicAssessment(userScoreData, topic.name);
        const courseHTML = createCourseHTML(topic, topicAssessment);
        courseList.insertAdjacentHTML('beforeend', courseHTML);
    });
    }

    // Find assessment data for a specific topic
    function findTopicAssessment(userScoreData, topicName) {
    if (!userScoreData || !userScoreData.scores || !Array.isArray(userScoreData.scores)) {
        console.log(`No scores found for user`);
        return null;
    }

    // Find the score for the specific topic
    const topicScore = userScoreData.scores.find(score => score.topic === topicName);
    
    if (topicScore) {
        console.log(`Found assessment for ${topicName}:`, topicScore);
        return {
        score: topicScore.percentage, // Use percentage as the score
        timeTaken: null, // You don't have timeTaken in your current data structure
        timestamp: topicScore.timestamp,
        totalQuestions: topicScore.totalQuestions,
        actualScore: topicScore.score, // Actual number of correct answers
        answers: topicScore.answers
        };
    }
    
    console.log(`No assessment found for topic: ${topicName}`);
    return null;
    }

    // Create HTML for a course item
    function createCourseHTML(topic, assessment) {
    const isCompleted = assessment && assessment.score !== undefined && assessment.score !== null;
    const score = assessment ? Math.round(assessment.score || 0) : 0;
    const actualScore = assessment ? assessment.actualScore : 0;
    const totalQuestions = assessment ? assessment.totalQuestions : 15;
    const lastAttempted = assessment ? assessment.timestamp : null;
    
    // Determine progress bar color based on score 
    let progressBarClass = 'bg-primary';
    let badgeStyle = 'background: linear-gradient(45deg, #007bff, #0056b3);';
    
    if (score >= 80) {
        progressBarClass = 'bg-success';
        badgeStyle = 'background: linear-gradient(45deg, #28a745, #20c997);';
    } else if (score >= 60) {
        progressBarClass = 'bg-info';
        badgeStyle = 'background: linear-gradient(45deg, #17a2b8, #138496);';
    } else if (score >= 40) {
        progressBarClass = 'bg-warning';
        badgeStyle = 'background: linear-gradient(45deg, #ffc107, #fd7e14);';
    } else if (score > 0) {
        progressBarClass = 'bg-danger';
        badgeStyle = 'background: linear-gradient(45deg, #dc3545, #c82333);';
    }

    // Update the action button logic
    const actionButton = isCompleted 
        ? `<div class="completed-badge">
            <i class="bi bi-check-circle me-2"></i>
            Completed
        </div>
        <div class="mt-2">
            <small class="text-muted d-block">Score: ${actualScore}/${totalQuestions}</small>
        </div>`
        : `<a href="${topic.url}" class="btn btn-primary btn-sm">
            <span>Start Assessment</span>
            <i class="bi bi-arrow-right ms-2"></i>
        </a>`;

    // Set progress bar width
    const progressWidth = isCompleted ? score : 0;

    return `
        <div class="course-item mb-3" data-topic="${topic.id}">
        <div class="card course-card h-100 border-0 shadow-sm hover-shadow">
            <div class="card-body p-3">
            <div class="row align-items-center">
                <div class="col-lg-1 col-md-2 text-center">
                <div class="icon-box ${isCompleted ? 'bg-success' : 'bg-primary'} text-white rounded-circle p-2" style="width: 40px; height: 40px;">
                    <i class="bi ${isCompleted ? 'bi-check-circle' : topic.icon} fs-5"></i>
                </div>
                </div>
                <div class="col-lg-6 col-md-5">
                <h4 class="mb-1 fs-5">${topic.displayName}</h4>
                <p class="text-muted mb-2 fs-6">${topic.description}</p>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar ${progressBarClass}" role="progressbar" 
                        style="width: ${progressWidth}%"
                        aria-valuenow="${score}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                ${lastAttempted ? 
                    `<small class="text-muted">Completed on: ${new Date(lastAttempted).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                    })}</small>` 
                    : '<small class="text-muted">Not attempted yet</small>'}
                </div>
                <div class="col-lg-2 col-md-2 text-center">
                <span class="percentage-badge" style="${badgeStyle}">${score}%</span>
                </div>
                <div class="col-lg-3 col-md-3 text-end">
                ${actionButton}
                </div>
            </div>
            </div>
        </div>
        </div>
    `;
    }

    // Show/hide loading indicator
    function showLoading(show) {
    const loadingMessage = document.getElementById('loadingMessage');
    if (loadingMessage) {
        loadingMessage.style.display = show ? 'block' : 'none';
    }
    }

    // Show error message
    function showError(message) {
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    if (errorMessage && errorText) {
        errorText.textContent = message;
        errorMessage.classList.remove('d-none');
    }
    }

    // Hide error message
    function hideError() {
    const errorMessage = document.getElementById('errorMessage');
    if (errorMessage) {
        errorMessage.classList.add('d-none');
    }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing application...');
    initializeApp();
    });

    // Add refresh functionality
    function refreshCourseData() {
    hideError();
    initializeApp();
    }

    // Optional: Add refresh button (you can add this to your HTML if needed)
    function addRefreshButton() {
    const refreshButton = document.createElement('button');
    refreshButton.className = 'btn btn-outline-primary btn-sm';
    refreshButton.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
    refreshButton.onclick = refreshCourseData;
    
    const errorMessage = document.getElementById('errorMessage');
    if (errorMessage) {
        errorMessage.appendChild(refreshButton);
    }
    }
</script>
</body>
</html>
