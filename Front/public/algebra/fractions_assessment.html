<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fractions Practice</title>
  <style>
    /* Add your CSS styling here */
  </style>
</head>
<body>
  <h1>Fractions Practice</h1>
  <div id="question-container">
    <p id="difficulty"></p>
    <p id="question"></p>
    <button onclick="answerQuestion(true)">Correct</button>
    <button onclick="answerQuestion(false)">Incorrect</button>
  </div>
  <button id="next-topic" style="display: none;">Next Topic</button>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
            let username = '';
            let email = '';

            async function fetchSessionInfo() {
                try {
                    const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/session-info');
                    if (response.ok) {
                        const data = await response.json();
                        username = data.username;
                        email = data.email;
                        console.log(username, email)
                    } else {
                        console.error('Failed to fetch session info');
                    }
                } catch (error) {
                    console.error('Error fetching session info:', error);
                }
            }

            await fetchSessionInfo();
        });


    const params = new URLSearchParams(window.location.search);
    const topic = params.get('topic');
    let difficultyLevel = 'hard';
    let consecutiveCorrect = 0;
    let answeredQuestions = [];

    async function fetchQuestion() {
      const response = await fetch(`https://sanghamitra-learnworld.vercel.app/api/algebra_questions?topic=${topic}&difficultyLevel=${difficultyLevel}`);
      const questions = await response.json();
      const question = questions.find(q => !answeredQuestions.includes(q._id));

      if (question) {
        document.getElementById('difficulty').innerText = `Difficulty: ${difficultyLevel}`;
        document.getElementById('question').innerText = question.question;
        return question;
      } else {
        return null;
      }
    }

    async function answerQuestion(correct) {
      const question = await fetchQuestion();

      if (question) {
        answeredQuestions.push(question._id);
        await fetch('https://sanghamitra-learnworld.vercel.app/api/algebra_score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, topic, questionId: question._id, answer: 'user_answer', correct, difficultyLevel })
        });

        if (correct) {
          if (difficultyLevel === 'hard') consecutiveCorrect++;
          difficultyLevel = difficultyLevel === 'easy' ? 'medium' : 'hard';
        } else {
          consecutiveCorrect = 0;
          difficultyLevel = difficultyLevel === 'hard' ? 'medium' : 'easy';
        }

        if (consecutiveCorrect === 4) {
          document.getElementById('next-topic').style.display = 'block';
          document.getElementById('next-topic').innerText = `Next Topic: Decimals`;
        } else {
          fetchQuestion();
        }
      } else {
        alert('No more questions available for this topic.');
      }
    }

    fetchQuestion();
  </script>
</body>
</html>
