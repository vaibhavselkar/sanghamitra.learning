<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fractions Practice</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #question-container {
      margin-top: 20px;
    }
    button {
      margin: 10px;
    }
    #explanation {
      margin-top: 20px;
    }
    .correct {
      background-color: green;
      color: white;
    }
    .incorrect {
      background-color: red;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Fractions Practice</h1>
  <div id="question-container">
    <p id="difficulty"></p>
    <p id="question"></p>
    <div id="options"></div>
    <button id="submit-button" style="display: none;" onclick="showExplanation()">Submit</button>
  </div>
  <div id="explanation" style="display: none;">
    <p id="explanation-text"></p>
    <p id="correct-option" style="color: green;"></p>
    <button id="next-button" onclick="fetchQuestion()">Next</button>
  </div>
  <button id="next-topic" style="display: none;" onclick="location.href='decimals_assessment.html'">Next Topic: Decimals</button>

  <script>
    let username = '';
    let email = '';
    let currentQuestion = null;
    let selectedOption = null;

    async function fetchSessionInfo() {
      try {
        const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/session-info');
        if (response.ok) {
          const data = await response.json();
          username = data.username;
          email = data.email;
          console.log(username, email);
        } else {
          console.error('Failed to fetch session info');
        }
      } catch (error) {
        console.error('Error fetching session info:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchSessionInfo();
      fetchQuestion();
    });

    const topic = 'fractions';
    let difficultyLevel = 'hard';
    let consecutiveCorrect = 0;
    let answeredQuestions = [];

    async function fetchQuestion() {
      document.getElementById('explanation').style.display = 'none';
      document.getElementById('submit-button').style.display = 'none';
      const response = await fetch(`https://sanghamitra-learnworld.vercel.app/api/algebra_questions?topic=${topic}&difficultyLevel=${difficultyLevel}`);
      const questions = await response.json();
      const question = questions.find(q => !answeredQuestions.includes(q._id));

      if (question) {
        currentQuestion = question;
        selectedOption = null;
        document.getElementById('difficulty').innerText = `Difficulty: ${difficultyLevel}`;
        document.getElementById('question').innerText = question.question;

        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';
        for (const [key, value] of Object.entries(question.options)) {
          const button = document.createElement('button');
          button.innerText = value;
          button.onclick = () => selectOption(button, key === question.correctOption, question);
          optionsDiv.appendChild(button);
        }
      } else {
        alert('No more questions available for this topic.');
      }
    }

    function selectOption(button, correct, question) {
      if (selectedOption) {
        selectedOption.classList.remove('correct', 'incorrect');
      }
      selectedOption = button;
      button.classList.add(correct ? 'correct' : 'incorrect');
      document.getElementById('submit-button').style.display = 'block';
    }

    async function showExplanation() {
      const correct = selectedOption.classList.contains('correct');
      answeredQuestions.push(currentQuestion._id);
      await fetch('https://sanghamitra-learnworld.vercel.app/api/algebra_score_add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username,
          email,
          topics: [
            {
              topic,
              questions: [
                {
                  questionId: currentQuestion._id,
                  answer: correct ? currentQuestion.correctOption : 'user_answer',
                  correct,
                  difficultyLevel
                }
              ]
            }
          ]
        })
      });

      document.getElementById('explanation').style.display = 'block';
      document.getElementById('explanation-text').innerText = currentQuestion.explanation;
      if (!correct) {
        document.getElementById('correct-option').innerText = `Correct Option: ${currentQuestion.options[currentQuestion.correctOption]}`;
      } else {
        document.getElementById('correct-option').innerText = '';
      }

      if (correct) {
        if (difficultyLevel === 'hard') consecutiveCorrect++;
        difficultyLevel = difficultyLevel === 'easy' ? 'medium' : 'hard';
      } else {
        consecutiveCorrect = 0;
        difficultyLevel = difficultyLevel === 'hard' ? 'medium' : 'easy';
      }

      if (consecutiveCorrect === 4) {
        document.getElementById('next-topic').style.display = 'block';
      }
    }
  </script>
</body>
</html>
