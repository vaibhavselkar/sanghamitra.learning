<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Analytics</title>
    <!-- Fonts and CSS dependencies -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content {
            flex: 1;
            display: flex;
            overflow-y: auto;
        }
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #28a745;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .dashboard h1 {
            text-align: center;
        }
        .card {
            background: #fff;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 0 10px rgba(42, 179, 165, 0.1);
        }
        .card h2 {
            margin: 0 0 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 700px; /* Ensure charts fit within the page margin */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .sidebar {
            width: 300px;
            background-color: #6c757d;
            color: #fff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(139, 135, 135, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar h2 {
            text-align: center;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        .sidebar ul li a {
            color: #fff;
            text-decoration: none;
            display: block;
        }
        .sidebar ul li a:hover {
            background-color: #555;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
        <a href="index.html" class="logo d-flex align-items-center me-auto">
            <img src="img/sbi.logo.png" alt="Logo" width="80" height="80"> 
            <h1 class="">Sanghamitra Learning</h1>
        </a>
        <nav id="navmenu" class="navmenu">
            <div id="navbar-placeholder"></div>
            <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>
    </div>
</header>

<div class="content">
    <div class="main-content">
        <div class="dashboard">
            <h1>Quiz Analytics for <span id="username">User</span></h1>
            <div class="card">
                <h2>Total Points Earned</h2>
                <p id="totalScore">N/A</p>
            </div>
            <div class="card">
                <h2>Accuracy</h2>
                <p id="accuracy">N/A <span id="accuracyDetails" style="display: none;"></span></p>
                <div>
                    <p id="correctAnswers">Correct: N/A</p>
                    <p id="incorrectAnswers">Incorrect: N/A</p>
                    <p id="skippedQuestions">Skipped: N/A</p>
                </div>
            </div>
            <div class="card chart-container">
                <canvas id="difficultyChart"></canvas>
            </div>
            <div class="card chart-container">
                <canvas id="cefrChart"></canvas>
            </div>
            <div class="card">
                <h2>Question Analysis</h2>
                <table id="questionTable">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Topic</th>
                            <th>CEFR Level</th>
                            <th>Difficulty</th>
                            <th>Your Response</th>
                            <th>Correct Answer</th>
                            <th>Points Awarded</th> 
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <h2>Additional Resources</h2>
        <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Profile</a></li>
            <li><a href="#">Analytics</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
    </div>
</div>

<footer id="footer" class="footer position-relative">
    <div class="container footer-top">
        <div class="row gy-4">
            <div class="col-lg-4 col-md-6 footer-about">
                <a href="index.html" class="logo d-flex align-items-center">
                    <span class="">Sanghamitra Learning</span>
                </a>
                <div class="footer-contact pt-3">
                    <p>GacchiBowli</p>
                    <p>Hyderabad, TS 500032</p>
                    <p class="mt-3"><strong>Phone:</strong> <span>+91 7020102729</span></p>
                    <p><strong>Email:</strong> <span>sanghamitra.learnworlds@gmail.com</span></p>
                </div>
                <div class="social-links d-flex mt-4">
                    <a href=""><i class="bi bi-twitter"></i></a>
                    <a href=""><i class="bi bi-facebook"></i></a>
                    <a href=""><i class="bi bi-instagram"></i></a>
                    <a href=""><i class="bi bi-linkedin"></i></a>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 footer-newsletter">
                <!-- Add newsletter form or other content here if needed -->
            </div>
        </div>
    </div>
    <div class="container copyright text-center mt-4">
        <p>Â© <span>Copyright</span> <strong class="px-1">Sanghamitra Learning</strong> <span>All Rights Reserved</span></p>
        <div class="credits">
            Designed by <a href="index.html">Sanghamitra</a>
        </div>
    </div>
</footer>

<script>
    let username = '';
    let email = '';

    async function fetchSessionInfo() {
        try {
            const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/session-info');
            if (response.ok) {
                const data = await response.json();
                username = data.username;
                email = data.email;
                document.getElementById('username').innerText = username;
                await fetchUserData(email); // Fetch user data after getting the session info
            } else {
                console.error('Failed to fetch session info');
            }
        } catch (error) {
            console.error('Error fetching session info:', error);
        }
    }

    async function fetchUserData(email) {
        try {
            const quizId = new URLSearchParams(window.location.search).get('quizId');
            const response = await fetch(`https://sanghamitra-learnworld.vercel.app/api/vocabscores?email=${email}&date=${quizId}`);
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            const userData = await response.json();
            processUserData(userData);
        } catch (error) {
            console.error('There has been a problem with your fetch operation:', error);
        }
    }

    function processUserData(userData) {
        if (!userData || !userData.assessments || userData.assessments.length === 0) {
            console.error('Invalid user data', userData);
            return;
        }

        // Get the last entry in the assessments array
        const assessments = userData.assessments[userData.assessments.length - 1];
        if (!assessments) {
            console.error('No assessments found for user', userData);
            return;
        }

        const totalQuestions = assessments.questions.length;
        const correctAnswers = assessments.questions.filter(q => q.is_correct).length;
        const incorrectAnswers = assessments.questions.filter(q => !q.is_correct && q.user_response !== "").length;
        const skippedQuestions = assessments.questions.filter(q => q.user_response === "").length;
        const accuracy = (correctAnswers / totalQuestions) * 100;

        const topicScores = {};
        const difficultyScores = {};
        const cefrScores = {};

        assessments.questions.forEach(question => {
            const topic = question.topic;
            const difficulty = question.difficulty_level;
            const cefr = question.CEFR_level;

            if (!topicScores[topic]) topicScores[topic] = { correct: 0, total: 0 };
            if (!difficultyScores[difficulty]) difficultyScores[difficulty] = { correct: 0, total: 0 };
            if (!cefrScores[cefr]) cefrScores[cefr] = { correct: 0, total: 0 };

            topicScores[topic].total++;
            difficultyScores[difficulty].total++;
            cefrScores[cefr].total++;

            if (question.is_correct) {
                topicScores[topic].correct++;
                difficultyScores[difficulty].correct++;
                cefrScores[cefr].correct++;
            }
        });

        document.getElementById('totalScore').innerText = assessments.total_score;
        document.getElementById('accuracy').innerText = accuracy.toFixed(2) + '%';
        document.getElementById('accuracy').setAttribute('title', `${correctAnswers}/${totalQuestions}`);
        document.getElementById('correctAnswers').innerText = `Correct: ${correctAnswers}`;
        document.getElementById('incorrectAnswers').innerText = `Incorrect: ${incorrectAnswers}`;
        document.getElementById('skippedQuestions').innerText = `Skipped: ${skippedQuestions}`;

        createCharts({
            difficultyScores,
            cefrScores
        });

        populateQuestionTable(assessments.questions);
    }

    function createCharts(data) {
        const ctxDifficulty = document.getElementById('difficultyChart').getContext('2d');
        const ctxCEFR = document.getElementById('cefrChart').getContext('2d');

        const difficultyData = Object.keys(data.difficultyScores).map(difficulty => data.difficultyScores[difficulty].correct / data.difficultyScores[difficulty].total * 100);
        const cefrData = Object.keys(data.cefrScores).map(cefr => data.cefrScores[cefr].correct / data.cefrScores[cefr].total * 100);

        new Chart(ctxDifficulty, {
            type: 'bar',
            data: {
                labels: Object.keys(data.difficultyScores),
                datasets: [{
                    label: 'Difficulty Scores',
                    data: difficultyData,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        new Chart(ctxCEFR, {
            type: 'bar',
            data: {
                labels: Object.keys(data.cefrScores),
                datasets: [{
                    label: 'CEFR Scores',
                    data: cefrData,
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function populateQuestionTable(questions) {
        const tableBody = document.getElementById('questionTable').getElementsByTagName('tbody')[0];
        questions.forEach(question => {
            const row = tableBody.insertRow();
            row.insertCell(0).innerText = question.question_text;
            row.insertCell(1).innerText = question.topic;
            row.insertCell(2).innerText = question.CEFR_level;
            row.insertCell(3).innerText = question.difficulty_level;
            row.insertCell(4).innerText = question.user_response;
            row.insertCell(5).innerText = question.correct_option;
            row.insertCell(6).innerText = question.points_awarded;
        });
    }

    async function init() {
        await fetchSessionInfo();
    }

    init();
</script>

<!-- Vendor JS Files -->
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/vendor/php-email-form/validate.js"></script>
<script src="assets/vendor/aos/aos.js"></script>
<script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
<script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

<!-- Main JS File -->
<script src="assets/js/main.js"></script>
<script src="navbar.js"></script>

</body>
</html>
