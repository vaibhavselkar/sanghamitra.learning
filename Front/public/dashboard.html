<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Analytics</title>
    <!-- Fonts and CSS dependencies -->
    <title>User Dashboard</title>
    <link rel="stylesheet" href="quiz.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">
    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content {
            flex: 1;
            display: flex;
            overflow-y: auto;
        }
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #28a745;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .dashboard h1 {
            text-align: center;
        }
        .card {
        .card-custom {
            background: #fff;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 0 10px rgba(42, 179, 165, 0.1);
        }
        .card h2 {
            margin: 0 0 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 700px; /* Ensure charts fit within the page margin */
            box-shadow: 0 0 10px #6c757d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        .card-custom h2, .card-custom h3 {
            margin: 0 0 10px;               
        }
        table, th, td {
            border: 1px solid #ddd;
        .btn-custom-small {
            font-size: 0.70rem; /* Adjust font size */
            padding: 0.12rem 0.3rem; /* Adjust padding */
            border-radius: 0.1rem; /* Adjust border radius */
            background-color: #5fcf80; /* Custom background color */
            color: black; /* Custom text color */
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .sidebar {
            width: 300px;
            background-color: #6c757d;
            color: #fff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(139, 135, 135, 0.1);
        .card-container {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar h2 {
            text-align: center;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        .sidebar ul li a {
            color: #fff;
            text-decoration: none;
            display: block;
        }
        .sidebar ul li a:hover {
            background-color: #555;
        .card-container .card-custom {
            flex: 0 0 48%;
            margin-bottom: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
        <a href="index.html" class="logo d-flex align-items-center me-auto">
            <img src="img/sbi.logo.png" alt="Logo" width="80" height="80"> 
            <h1 class="">Sanghamitra Learning</h1>
            <h1 class=""><img src="img/sbi.logo.png" alt="company logo" width="80" height="80">Sanghamitra Learning</h1>
        </a>
        <nav id="navmenu" class="navmenu">
            <div id="navbar-placeholder"></div>
            <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>
    </div>
</header>

<div class="content">
    <div class="main-content">
        <div class="dashboard">
            <h1>Quiz Analytics for <span id="username">User</span></h1>
            <div class="card">
                <h2>Total Points Earned</h2>
                <p id="totalScore">N/A</p>
            </div>
            <div class="card">
                <h2>Accuracy</h2>
                <p id="accuracy">N/A <span id="accuracyDetails" style="display: none;"></span></p>
                <div>
                    <p id="correctAnswers">Correct: N/A</p>
                    <p id="incorrectAnswers">Incorrect: N/A</p>
                    <p id="skippedQuestions">Skipped: N/A</p>

<main class="main">
    <section class="container mt-5">
        <div class="row">
            <div class="col-lg-12 mx-auto" data-aos="fade-up">
                <div class="card shadow-sm mb-4 bg-light">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">Student Dashboard</h2>
                    </div>
                    <div class="card-body">
                        <div class="card-custom mb-4">
                            <h3>User Information</h3>
                            <p><strong>Username:</strong> <span id="userName"></span></p>
                            <p><strong>Email:</strong> <span id="userEmail"></span></p>
                        </div>
                        <div class="card-container">
                            <div class="card-custom">
                                <h3>Vocabulary</h3>
                                <p><strong>Total Points Earned:</strong> <span id="total-score"></span></p>
                                <p><strong>Number of Quizzes Taken:</strong> <span id="quiz-count"></span></p>
                                <div id="quiz-scores">
                                    <h4>Individual Scores</h4>
                                    <ul id="quiz-scores-list"></ul>
                                </div>
                                <div id="strengths-container">
                                    <h4>Strengths</h4>
                                    <ul id="strengths-list"></ul>
                                </div>
                                <div id="weaknesses-container">
                                    <h4>Weaknesses</h4>
                                    <ul id="weaknesses-list"></ul>
                                </div>
                            </div>
                            <div class="card-custom">
                                <h3>Mathematics</h3>
                                <p><strong>Total Score:</strong> <span id="math-total-score">N/A</span></p>
                            </div>
                            <div class="card-custom">
                                <h3>Reading Comprehension</h3>
                                <p><strong>Total Score:</strong> <span id="reading-total-score">N/A</span></p>
                            </div>
                            <div class="card-custom">
                                <h3>Computer Science</h3>
                                <p><strong>Total Score:</strong> <span id="cs-total-score">N/A</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card chart-container">
                <canvas id="difficultyChart"></canvas>
            </div>
            <div class="card chart-container">
                <canvas id="cefrChart"></canvas>
            </div>
            <div class="card">
                <h2>Question Analysis</h2>
                <table id="questionTable">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Topic</th>
                            <th>CEFR Level</th>
                            <th>Difficulty</th>
                            <th>Your Response</th>
                            <th>Correct Answer</th>
                            <th>Points Awarded</th> 
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <h2>Additional Resources</h2>
        <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Profile</a></li>
            <li><a href="#">Analytics</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
    </div>
</div>
    </section>
</main>

<footer id="footer" class="footer position-relative">
    <div class="container footer-top">
@@ -196,166 +133,166 @@ <h2>Additional Resources</h2>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 footer-newsletter">
                <!-- Add newsletter form or other content here if needed -->
            </div>
        </div>
    </div>
    <div class="container copyright text-center mt-4">
        <p>© <span>Copyright</span> <strong class="px-1">Sanghamitra Learning</strong> <span>All Rights Reserved</span></p>
        <div class="credits">
            Designed by <a href="index.html">Sanghamitra</a>
            Designed by <a href="">Sanghamitra</a>
        </div>
    </div>
</footer>

<script>
    let username = '';
    let email = '';

    async function fetchSessionInfo() {
    async function fetchVocabscores(email) {
        try {
            const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/session-info');
            if (response.ok) {
                const data = await response.json();
                username = data.username;
                email = data.email;
                document.getElementById('username').innerText = username;
                await fetchUserData(email); // Fetch user data after getting the session info
            } else {
                console.error('Failed to fetch session info');
            const response = await fetch(`https://sanghamitra-learnworld.vercel.app/api/vocabscores?email=${email}`);
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            const userData = await response.json();
            return userData;
        } catch (error) {
            console.error('Error fetching session info:', error);
            console.error('There has been a problem with your fetch operation:', error);
            return null;
        }
    }

    async function fetchUserData(email) {
    async function fetchUserDashboard() {
        try {
            const quizdate = new URLSearchParams(window.location.search).get('quizId');
            const response = await fetch(https://sanghamitra-learnworld.vercel.app/api/vocabscores?email=${email}&date=${quizdate});
            const response = await fetch('https://sanghamitra-learnworld.vercel.app/api/dashboard', {
                method: 'GET',
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json"
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
                location.replace('user_login.html');
                return null;
            }

            const userData = await response.json();
            processUserData(userData);
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userEmail').textContent = userData.email;
            return userData;
        } catch (error) {
            console.error('There has been a problem with your fetch operation:', error);
            console.log('Fetch user data failed:', error);
            return null;
        }
    }

    function processUserData(userData) {
        if (!userData || !userData.assessment) {
            console.error('Invalid user data', userData);
            return;
        }
    function processUserData(user) {
        const assessments = user.assessments;
        const latestAssessment = assessments[0];

        const assessment = userData.assessment;
        const totalQuestions = assessment.questions.length;
        const correctAnswers = assessment.questions.filter(q => q.is_correct).length;
        const incorrectAnswers = assessment.questions.filter(q => !q.is_correct && q.user_response !== "").length;
        const skippedQuestions = assessment.questions.filter(q => q.user_response === "").length;
        const totalQuestions = latestAssessment.questions.length;
        const correctAnswers = latestAssessment.questions.filter(q => q.is_correct).length;
        const accuracy = (correctAnswers / totalQuestions) * 100;

        const topicScores = {};
        const difficultyScores = {};
        const cefrScores = {};

        assessment.questions.forEach(question => {
            const difficulty = question.difficulty_level;
            const cefr = question.CEFR_level;

            if (!difficultyScores[difficulty]) difficultyScores[difficulty] = { correct: 0, total: 0 };
            if (!cefrScores[cefr]) cefrScores[cefr] = { correct: 0, total: 0 };

            difficultyScores[difficulty].total++;
            cefrScores[cefr].total++;
        const strengths = [];
        const weaknesses = [];

        const topicScores = {};
        latestAssessment.questions.forEach(question => {
            const topic = question.topic;
            if (!topicScores[topic]) topicScores[topic] = { correct: 0, total: 0 };
            topicScores[topic].total++;
            if (question.is_correct) {
                difficultyScores[difficulty].correct++;
                cefrScores[cefr].correct++;
                topicScores[topic].correct++;
            }
        });

        document.getElementById('totalScore').innerText = assessment.total_score;
        document.getElementById('accuracy').innerText = accuracy.toFixed(2) + '%';
        document.getElementById('accuracy').setAttribute('title', ${correctAnswers}/${totalQuestions});
        document.getElementById('correctAnswers').innerText = Correct: ${correctAnswers};
        document.getElementById('incorrectAnswers').innerText = Incorrect: ${incorrectAnswers};
        document.getElementById('skippedQuestions').innerText = Skipped: ${skippedQuestions};

        createCharts({
            difficultyScores,
            cefrScores
        Object.keys(topicScores).forEach(topic => {
            const score = (topicScores[topic].correct / topicScores[topic].total) * 100;
            if (score >= 75) {
                strengths.push(topic);
            } else if (score < 50) {
                weaknesses.push(topic);
            }
        });

        populateQuestionTable(assessment.questions);
        const quizScores = assessments.map(assessment => ({
            id: assessment._id,
            date: assessment.date,
            score: assessment.total_score
        }));

        const totalScore = quizScores.reduce((total, quiz) => total + quiz.score, 0);

        return {
            totalScore,
            accuracy: accuracy.toFixed(2),
            strengths,
            weaknesses,
            quizCount: assessments.length,
            quizScores
        };
    }

    function createCharts(data) {
        const ctxDifficulty = document.getElementById('difficultyChart').getContext('2d');
        const ctxCEFR = document.getElementById('cefrChart').getContext('2d');
    function displayUserData(user) {
        const processedData = processUserData(user);
        document.getElementById('total-score').innerText = processedData.totalScore;
        document.getElementById('quiz-count').innerText = processedData.quizCount;

        const difficultyData = Object.keys(data.difficultyScores).map(difficulty => data.difficultyScores[difficulty].correct / data.difficultyScores[difficulty].total * 100);
        const cefrData = Object.keys(data.cefrScores).map(cefr => data.cefrScores[cefr].correct / data.cefrScores[cefr].total * 100);
        const strengthsList = document.getElementById('strengths-list');
        strengthsList.innerHTML = ''; // Clear previous list
        processedData.strengths.forEach(topic => {
            const listItem = document.createElement('li');
            listItem.innerText = topic;
            strengthsList.appendChild(listItem);
        });

        new Chart(ctxDifficulty, {
            type: 'bar',
            data: {
                labels: Object.keys(data.difficultyScores),
                datasets: [{
                    label: 'Difficulty Scores',
                    data: difficultyData,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        const weaknessesList = document.getElementById('weaknesses-list');
        weaknessesList.innerHTML = ''; // Clear previous list
        processedData.weaknesses.forEach(topic => {
            const listItem = document.createElement('li');
            listItem.innerText = topic;
            weaknessesList.appendChild(listItem);
        });

        new Chart(ctxCEFR, {
            type: 'bar',
            data: {
                labels: Object.keys(data.cefrScores),
                datasets: [{
                    label: 'CEFR Scores',
                    data: cefrData,
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        const quizScoresList = document.getElementById('quiz-scores-list');
        quizScoresList.innerHTML = ''; // Clear previous list
        processedData.quizScores.forEach(quiz => {
            const listItem = document.createElement('li');
            const quizDate = new Date(quiz.date).toLocaleDateString();
            listItem.innerHTML = `Date: ${quizDate}, Score: ${quiz.score} <button class="btn btn-custom-small" onclick="goToQuizAnalytics('${quiz.date}')">View Analytics</button>`;
            quizScoresList.appendChild(listItem);
        });
    }

    function populateQuestionTable(questions) {
        const tableBody = document.getElementById('questionTable').getElementsByTagName('tbody')[0];
        questions.forEach(question => {
            const row = tableBody.insertRow();
            row.insertCell(0).innerText = question.question_text;
            row.insertCell(1).innerText = question.topic;
            row.insertCell(2).innerText = question.CEFR_level;
            row.insertCell(3).innerText = question.difficulty_level;
            row.insertCell(4).innerText = question.user_response;
            row.insertCell(5).innerText = question.correct_option;
            row.insertCell(6).innerText = question.points_awarded;
        });
    function goToQuizAnalytics(quizId) {
        window.location.href = `vocab_analytics.html?quizId=${encodeURIComponent(quizId)}`;
    }

    async function init() {
        await fetchSessionInfo();
        const userDashboardData = await fetchUserDashboard();
        if (!userDashboardData) {
            console.error('Failed to fetch user dashboard data');
            return;
        }

        const vocabScoresData = await fetchVocabscores(userDashboardData.email);
        if (!vocabScoresData) {
            console.error('Failed to fetch vocab scores data');
            return;
        }

        displayUserData(vocabScoresData);
    }

    init();
</script>


<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/vendor/php-email-form/validate.js"></script>
@@ -367,6 +304,5 @@ <h2>Additional Resources</h2>
<!-- Main JS File -->
<script src="assets/js/main.js"></script>
<script src="navbar.js"></script>

</body>
</html>
