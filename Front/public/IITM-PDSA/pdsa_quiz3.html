<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linear Data Structures Quiz</title>
    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Anti-cheating CSS */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Allow text selection ONLY in code editors */
        .monaco-editor,
        .monaco-editor *,
        .view-lines,
        .view-line {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, nghns-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-print-color-adjust: exact;
            pointer-events: auto;
        }
        
        /* Hide scrollbars to prevent inspection */
        ::-webkit-scrollbar {
            width: 8px;
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }
        
        /* Blur content when window loses focus */
        body.blurred {
            filter: blur(10px);
            pointer-events: none;
        }
        
        /* Warning overlay */
        .warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 2rem;
            text-align: center;
            flex-direction: column;
        }
        
        .warning-overlay h2 {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .quiz-container { padding: 30px; }
        .question-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }
        .code-editor-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            height: 400px;
        }
        .test-cases {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .test-passed {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-failed {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .score-display {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .results-container { display: none; padding: 30px; }
        .explanation-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 1.2rem;
            margin-top: 20px;
        }
        
        /* Security indicator */
        .security-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .security-indicator.warning {
            background: rgba(220, 53, 69, 0.9);
            animation: pulse 1s infinite;
        }
        
        .security-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }
        
        /* Answers Modal Styles */
        .answers-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }
        
        .answers-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            width: 800px;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 14px;
        }
        
        /* Button container for results */
        .results-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* Level Selection Styles */
        .level-container {
            padding: 30px;
            text-align: center;
        }
        
        .level-selection {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .level-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            width: 280px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #dee2e6;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .level-card.active {
            border-color: #28a745;
            background: #e8f5e8;
        }
        
        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }
        
        .level-card.locked:after {
            content: "üîí";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }
        
        .level-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .level-easy { background: #d4edda; color: #155724; }
        .level-medium { background: #fff3cd; color: #856404; }
        .level-hard { background: #f8d7da; color: #721c24; }
        
        .level-info {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .level-progress {
            margin-top: 20px;
        }
        
        .completion-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .results-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .results-buttons .btn {
                width: 100%;
            }
            
            .level-selection {
                flex-direction: column;
                align-items: center;
            }
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-level {
            margin-top: 20px;
            padding: 12px 40px;
            font-size: 18px;
        }

        /* Question navigation buttons container */
        .question-navigation {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        /* Progress container without text */
        .progress-container {
            margin-bottom: 25px;
        }
        
        /* Question number indicator in question card */
        .question-number {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        /* Level progress text */
        .level-progress-text {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        /* Remove the overall progress bar from level selection */
        .level-container .progress {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Security Indicator -->
    <div id="securityIndicator" class="security-indicator">
        <div class="security-dot"></div>
        <span id="securityText">Monitoring Active</span>
    </div>

    <!-- Warning overlay -->
    <div id="warningOverlay" class="warning-overlay">
        <div>
            <h2>‚ö†Ô∏è SUSPICIOUS ACTIVITY DETECTED</h2>
            <p style="font-size: 1.5rem;">Please return to the quiz window</p>
            <p style="font-size: 1.2rem;">Your activity is being monitored and logged</p>
            <p style="font-size: 1rem; margin-top: 20px;">Attempts logged: <span id="attemptCount">0</span></p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading Python Environment...</div>
        <small style="margin-top: 10px; opacity: 0.8;">This may take 10-15 seconds</small>
    </div>
    
    <!-- Answers Modal -->
    <div id="answersModal" class="answers-modal">
        <div class="answers-content">
            <h3>üìù Your Submitted Answers</h3>
            <div id="answersList"></div>
            <div class="text-center mt-4">
                <button class="btn btn-secondary" onclick="closeAnswersModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Linear Data Structures Quiz</h1>
            <p>Solve algorithmic problems by writing complete Python functions</p>
            <small style="opacity: 0.8;">‚ö†Ô∏è Anti-cheating measures active</small>
        </div>

        <!-- Level Selection Container -->
        <div id="levelContainer" class="level-container">
            <h3>Select Difficulty Level</h3>
            <p class="mb-4">Complete levels in sequence to unlock the next level</p>
            
            <div class="level-selection">
                <!-- Level 1 -->
                <div class="level-card active" id="level1Card" onclick="selectLevel(1)">
                    <div class="level-badge level-easy">Level 1</div>
                    <h4>Beginner</h4>
                    <p><strong>Difficulty:</strong> Easy</p>
                    <p><strong>Questions:</strong> 5 Problems</p>
                    <p><strong>Topics:</strong> Basic Algorithms</p>
                    <div class="level-info">
                        <p>üéØ Score ‚â• 60% to unlock Level 2</p>
                    </div>
                    <div id="level1Progress" class="level-progress">
                        <div id="level1Status"></div>
                        <button class="btn btn-success btn-level" onclick="startLevel(1)">Start Level 1</button>
                    </div>
                </div>
                
                <!-- Level 2 -->
                <div class="level-card" id="level2Card">
                    <div class="level-badge level-medium">Level 2</div>
                    <h4>Intermediate</h4>
                    <p><strong>Difficulty:</strong> Medium</p>
                    <p><strong>Questions:</strong> 5 Problems</p>
                    <p><strong>Topics:</strong> Advanced Concepts</p>
                    <div class="level-info">
                        <p>üîí Complete Level 1 first</p>
                    </div>
                    <div id="level2Progress" class="level-progress">
                        <div id="level2Status"></div>
                        <button class="btn btn-secondary btn-level" onclick="startLevel(2)" disabled>Locked</button>
                    </div>
                </div>
                
                <!-- Level 3 -->
                <div class="level-card" id="level3Card">
                    <div class="level-badge level-hard">Level 3</div>
                    <h4>Expert</h4>
                    <p><strong>Difficulty:</strong> Hard</p>
                    <p><strong>Questions:</strong> 5 Problems</p>
                    <p><strong>Topics:</strong> Complex Algorithms</p>
                    <div class="level-info">
                        <p>üîí Complete Level 2 first</p>
                    </div>
                    <div id="level3Progress" class="level-progress">
                        <div id="level3Status"></div>
                        <button class="btn btn-secondary btn-level" onclick="startLevel(3)" disabled>Locked</button>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 level-progress-text">
                <p><strong>Progress:</strong> <span id="overallProgress">Loading...</span></p>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="quiz-container" style="display: none;">
            <div id="questionContainer"></div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="results-container" style="display: none;">
            <div class="score-display">
                <h2 id="finalScore">0/100</h2>
                <h3 id="finalPercentage">0%</h3>
                <p id="levelCompletionText">Level Completed!</p>
                <div id="unlockMessage" style="margin-top: 20px;"></div>
            </div>
            <div id="detailedResults"></div>
            
            <!-- Fixed Button Layout -->
            <div class="results-buttons">
                <button class="btn btn-secondary" onclick="goToLevelSelection()">‚Üê Back to Levels</button>
                <button class="btn btn-info" onclick="showMyAnswers()">üìã View My Answers</button>
                <button class="btn btn-success" onclick="startNextLevel()" id="nextLevelBtn" style="display: none;">Next Level ‚Üí</button>
                <button class="btn btn-warning" onclick="retakeLevel()">üîÑ Retake This Level</button>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let cheatingAttempts = 0;
        let isQuizActive = false;
        let devToolsWarned = false;
        let tabSwitchCount = 0;
        let lastActivityTime = Date.now();
        let pyodide = null;
        let pyodideReady = false;
        let submittedQuizData = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let currentUser = {};
        let editors = {};
        
        // Level system variables
        let currentLevel = 1;
        let userSubmissions = [];
        
        // API Configuration
        const API_BASE_URL = 'https://sanghamitra-learnworld.vercel.app/api';
        const CODING_QUESTIONS_API = `${API_BASE_URL}/coding-questions`;
        const SUBMISSIONS_API = `${API_BASE_URL}/coding-submission`;
        const GET_SUBMISSIONS = `${API_BASE_URL}/coding-submissions`;
        
        // ===== ANTI-CHEATING SYSTEM =====
        function initializeAntiCheating() {
            // Disable right-click everywhere except code editor
            document.addEventListener('contextmenu', function(e) {
                if (!e.target.closest('.monaco-editor')) {
                    e.preventDefault();
                    recordCheatingAttempt('right_click');
                    return false;
                }
            });
            
            // Disable keyboard shortcuts (except in editor)
            document.addEventListener('keydown', function(e) {
                if (e.target.closest('.monaco-editor') || e.target.classList.contains('monaco-editor')) {
                    return true;
                }
                
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
                    (e.ctrlKey && e.keyCode === 85) || 
                    (e.ctrlKey && e.keyCode === 83) || 
                    e.keyCode === 44) {
                    e.preventDefault();
                    recordCheatingAttempt('keyboard_shortcut');
                    return false;
                }
                
                if (e.ctrlKey && (e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86)) {
                    e.preventDefault();
                    recordCheatingAttempt('copy_attempt');
                    return false;
                }
            });
            
            // Detect developer tools
            let devtools = {open: false, orientation: null};
            const threshold = 160;
            
            setInterval(function() {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open && isQuizActive) {
                        devtools.open = true;
                        recordCheatingAttempt('developer_tools');
                        if (!devToolsWarned) {
                            alert('‚ö†Ô∏è Developer tools detected! This attempt has been logged.\n\nContinued violations may result in quiz auto-submission.');
                            devToolsWarned = true;
                        }
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
            
            // Detect window focus changes
            window.addEventListener('blur', function() {
                if (isQuizActive) {
                    tabSwitchCount++;
                    document.body.classList.add('blurred');
                    document.getElementById('warningOverlay').style.display = 'flex';
                    document.getElementById('attemptCount').textContent = cheatingAttempts;
                    recordCheatingAttempt('window_blur_tab_switch');
                }
            });
            
            window.addEventListener('focus', function() {
                document.body.classList.remove('blurred');
                document.getElementById('warningOverlay').style.display = 'none';
                updateSecurityIndicator();
            });
            
            // Monitor for screenshot attempts
            document.addEventListener('keyup', function(e) {
                if (e.keyCode === 44 && isQuizActive) {
                    recordCheatingAttempt('screenshot_attempt');
                    alert('‚ö†Ô∏è Screenshot attempt detected and logged!');
                }
            });
            
            // Disable printing
            window.addEventListener('beforeprint', function(e) {
                if (isQuizActive) {
                    recordCheatingAttempt('print_attempt');
                    e.preventDefault();
                    alert('‚ö†Ô∏è Printing is disabled during the quiz.');
                    return false;
                }
            });
            
            // Monitor visibility changes
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && isQuizActive) {
                    recordCheatingAttempt('visibility_change');
                }
            });
            
            // Prevent text selection outside editor
            document.addEventListener('selectstart', function(e) {
                if (!e.target.closest('.monaco-editor') && isQuizActive) {
                    recordCheatingAttempt('text_selection');
                    return false;
                }
            });
        }
        
        function recordCheatingAttempt(type) {
            cheatingAttempts++;
            console.warn(`Cheating attempt #${cheatingAttempts}: ${type}`);
            document.getElementById('attemptCount').textContent = cheatingAttempts;
            updateSecurityIndicator(true);
            
            // Log to server
            if (currentUser.username && currentUser.email) {
                fetch(`${API_BASE_URL}/log-cheating`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: currentUser.username,
                        email: currentUser.email,
                        cheatingType: type,
                        timestamp: new Date(),
                        currentQuestion: currentQuestionIndex + 1,
                        totalAttempts: cheatingAttempts,
                        level: currentLevel
                    })
                }).catch(err => console.error('Failed to log cheating attempt:', err));
            }
            
            if (cheatingAttempts >= 10) {
                alert('‚ö†Ô∏è Too many suspicious activities detected!\n\nYour quiz will be auto-submitted now.');
                submitQuiz();
            } else if (cheatingAttempts >= 5) {
                alert(`‚ö†Ô∏è Warning: ${cheatingAttempts} suspicious activities detected!\n\nQuiz will auto-submit at 10 attempts.`);
            }
        }
        
        function updateSecurityIndicator(warning = false) {
            const indicator = document.getElementById('securityIndicator');
            const text = document.getElementById('securityText');
            
            if (warning) {
                indicator.classList.add('warning');
                text.textContent = `${cheatingAttempts} Violations Detected`;
                setTimeout(() => {
                    indicator.classList.remove('warning');
                    text.textContent = 'Monitoring Active';
                }, 3000);
            }
        }

        // ===== LEVEL MANAGEMENT =====
        async function loadUserProgress() {
            try {
                // Get current user info
                const sessionRes = await fetch(`${API_BASE_URL}/session-info`, {
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (sessionRes.ok) {
                    const sessionData = await sessionRes.json();
                    currentUser = { 
                        username: sessionData.username || 'TestUser', 
                        email: sessionData.email || 'test@example.com' 
                    };
                    
                    // Fetch user submissions
                    const submissionsRes = await fetch(`${GET_SUBMISSIONS}?email=${encodeURIComponent(currentUser.email)}`, {
                        credentials: 'include',
                        mode: 'cors'
                    });
                    
                    if (submissionsRes.ok) {
                        const submissionsData = await submissionsRes.json();
                        if (submissionsData.success) {
                            userSubmissions = submissionsData.submissions || [];
                        }
                    }
                }
            } catch (error) {
                console.log('Error loading progress:', error);
                userSubmissions = [];
            }
            
            updateLevelUI();
        }
        
        function getLevelScore(level) {
            // Map level to difficulty
            const difficultyMap = {1: 'easy', 2: 'medium', 3: 'hard'};
            const targetDifficulty = difficultyMap[level];
            
            // Find submissions for this difficulty
            const levelSubmissions = userSubmissions.filter(sub => {
                // Check both old format (level field) and new format (difficulty in questions)
                if (sub.level === level) return true;
                
                // If no level field, check questions difficulty
                if (sub.questions && sub.questions.length > 0) {
                    // All questions should have same difficulty in a level
                    const question = sub.questions[0];
                    return question.difficulty === targetDifficulty;
                }
                return false;
            });
            
            if (levelSubmissions.length === 0) return null;
            
            // Get the highest score for this level
            const bestSubmission = levelSubmissions.reduce((best, current) => 
                current.percentage > best.percentage ? current : best
            );
            
            return bestSubmission.percentage;
        }
        
        function isLevelCompleted(level) {
            return getLevelScore(level) !== null;
        }
        
        function updateLevelUI() {
            // Get scores for each level
            const level1Score = getLevelScore(1);
            const level2Score = getLevelScore(2);
            const level3Score = getLevelScore(3);
            
            // Update level 1
            const level1Status = document.getElementById('level1Status');
            if (level1Score !== null) {
                level1Status.innerHTML = `<div class="completion-badge">‚úì Completed: ${level1Score}%</div>`;
            } else {
                level1Status.innerHTML = '';
            }
            
            // Update level 2
            const level2Card = document.getElementById('level2Card');
            const level2Btn = level2Card.querySelector('button');
            const level2Status = document.getElementById('level2Status');
            
            if (level1Score !== null && level1Score >= 60) {
                level2Card.classList.remove('locked');
                level2Btn.disabled = false;
                level2Btn.className = 'btn btn-success btn-level';
                level2Btn.textContent = 'Start Level 2';
                level2Btn.onclick = () => startLevel(2);
                
                if (level2Score !== null) {
                    level2Status.innerHTML = `<div class="completion-badge">‚úì Completed: ${level2Score}%</div>`;
                } else {
                    level2Status.innerHTML = '';
                }
            } else {
                level2Card.classList.add('locked');
                level2Btn.disabled = true;
                level2Btn.className = 'btn btn-secondary btn-level';
                level2Btn.textContent = 'Locked';
                level2Status.innerHTML = '';
            }
            
            // Update level 3
            const level3Card = document.getElementById('level3Card');
            const level3Btn = level3Card.querySelector('button');
            const level3Status = document.getElementById('level3Status');
            
            if (level1Score !== null && level2Score !== null && level1Score >= 60 && level2Score >= 60) {
                level3Card.classList.remove('locked');
                level3Btn.disabled = false;
                level3Btn.className = 'btn btn-success btn-level';
                level3Btn.textContent = 'Start Level 3';
                level3Btn.onclick = () => startLevel(3);
                
                if (level3Score !== null) {
                    level3Status.innerHTML = `<div class="completion-badge">‚úì Completed: ${level3Score}%</div>`;
                } else {
                    level3Status.innerHTML = '';
                }
            } else {
                level3Card.classList.add('locked');
                level3Btn.disabled = true;
                level3Btn.className = 'btn btn-secondary btn-level';
                level3Btn.textContent = 'Locked';
                level3Status.innerHTML = '';
            }
            
            // Update overall progress
            const completedCount = [level1Score, level2Score, level3Score].filter(score => score !== null).length;
            document.getElementById('overallProgress').textContent = `${completedCount}/3 levels completed`;
        }
        
        function selectLevel(level) {
            const levelScore = getLevelScore(level);
            const isUnlocked = (level === 1) || 
                (level === 2 && getLevelScore(1) !== null && getLevelScore(1) >= 60) ||
                (level === 3 && getLevelScore(1) !== null && getLevelScore(2) !== null && 
                 getLevelScore(1) >= 60 && getLevelScore(2) >= 60);
            
            if (isUnlocked) {
                document.querySelectorAll('.level-card').forEach(card => card.classList.remove('active'));
                document.getElementById(`level${level}Card`).classList.add('active');
            }
        }
        
        async function startLevel(level) {
            currentLevel = level;
            
            // Check if level is unlocked
            const level1Score = getLevelScore(1);
            const level2Score = getLevelScore(2);
            
            if (level === 2 && (level1Score === null || level1Score < 60)) {
                alert('Please complete Level 1 with at least 60% score to unlock Level 2');
                return;
            }
            
            if (level === 3 && (level1Score === null || level2Score === null || level1Score < 60 || level2Score < 60)) {
                alert('Please complete both Level 1 and Level 2 with at least 60% score to unlock Level 3');
                return;
            }
            
            // Hide level selection, show loading
            document.getElementById('levelContainer').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelector('.loading-text').textContent = `Loading Level ${level} Questions...`;
            
            try {
                // Fetch questions for this level
                await fetchLevelQuestions(level);
                
                // Initialize quiz
                initializeQuiz();
                
            } catch (error) {
                console.error('Failed to start level:', error);
                alert('Failed to load questions. Please try again.');
                goToLevelSelection();
            }
        }
        
        async function fetchLevelQuestions(level) {
            const difficultyMap = {1: 'easy', 2: 'medium', 3: 'hard'};
            const difficulty = difficultyMap[level];
            
            try {
                const response = await fetch(`${CODING_QUESTIONS_API}?difficulty=${difficulty}&limit=5&topic=Linear%20Data%20Structures`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.questions && data.questions.length > 0) {
                        questions = data.questions.map(q => ({
                            ...q,
                            id: q.questionId,
                            points: q.maxScore || 20,
                            difficulty: q.difficulty || difficulty
                        }));
                        console.log(`‚úÖ Loaded ${questions.length} questions for Level ${level} (${difficulty})`);
                    } else {
                        throw new Error('No questions found');
                    }
                } else {
                    throw new Error('Failed to fetch questions');
                }
            } catch (error) {
                console.error('Error fetching questions:', error);
                // Fallback to local questions if API fails
                questions = getFallbackQuestions(level);
            }
        }
        
        function getFallbackQuestions(level) {
            // Fallback questions for demo
            const fallbackQuestions = [
                {
                    id: 1, questionId: 1, title: "Find Factors", 
                    description: "Find all factors of a number", difficulty: "easy",
                    prompt: "Write find_factors(n)", starterCode: "def find_factors(n):\n    pass",
                    functionName: "find_factors", testCases: [{input: 12, expected: [1,2,3,4,6,12]}],
                    maxScore: 20, points: 20
                },
                {
                    id: 2, questionId: 2, title: "Reverse String", 
                    description: "Reverse a string", difficulty: "easy",
                    prompt: "Write reverse_string(s)", starterCode: "def reverse_string(s):\n    pass",
                    functionName: "reverse_string", testCases: [{input: "hello", expected: "olleh"}],
                    maxScore: 20, points: 20
                },
                {
                    id: 3, questionId: 3, title: "Find Maximum", 
                    description: "Find maximum in a list", difficulty: "easy",
                    prompt: "Write find_maximum(lst)", starterCode: "def find_maximum(lst):\n    pass",
                    functionName: "find_maximum", testCases: [{input: [1,5,3,9,2], expected: 9}],
                    maxScore: 20, points: 20
                },
                {
                    id: 4, questionId: 4, title: "Check Palindrome", 
                    description: "Check if string is palindrome", difficulty: "easy",
                    prompt: "Write is_palindrome(s)", starterCode: "def is_palindrome(s):\n    pass",
                    functionName: "is_palindrome", testCases: [{input: "radar", expected: true}, {input: "hello", expected: false}],
                    maxScore: 20, points: 20
                },
                {
                    id: 5, questionId: 5, title: "Sum Even Numbers", 
                    description: "Sum all even numbers in list", difficulty: "easy",
                    prompt: "Write sum_even_numbers(lst)", starterCode: "def sum_even_numbers(lst):\n    pass",
                    functionName: "sum_even_numbers", testCases: [{input: [1,2,3,4,5,6], expected: 12}],
                    maxScore: 20, points: 20
                }
            ];
            return fallbackQuestions.map(q => ({...q, difficulty: level === 1 ? 'easy' : level === 2 ? 'medium' : 'hard'}));
        }
        
        function goToLevelSelection() {
            // Reset quiz state
            questions = [];
            currentQuestionIndex = 0;
            userAnswers = {};
            editors = {};
            cheatingAttempts = 0;
            tabSwitchCount = 0;
            isQuizActive = false;
            submittedQuizData = null;
            
            // Show level selection, hide other containers
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('levelContainer').style.display = 'block';
            
            // Reload progress from backend
            loadUserProgress();
            
            // Exit fullscreen
            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
        
        function startNextLevel() {
            const nextLevel = currentLevel + 1;
            if (nextLevel <= 3) {
                startLevel(nextLevel);
            } else {
                alert('üéâ Congratulations! You have completed all levels!');
                goToLevelSelection();
            }
        }
        
        function retakeLevel() {
            if (confirm(`Retake Level ${currentLevel}? Your previous score will be replaced.`)) {
                startLevel(currentLevel);
            }
        }

        // ===== QUIZ FUNCTIONS =====
        async function initPyodide() {
            const loadingText = document.querySelector('.loading-text');
            try {
                loadingText.textContent = 'Loading Python interpreter...';
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                loadingText.textContent = 'Python ready!';
                pyodideReady = true;
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
                require(['vs/editor/editor.main'], function() {
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('quizContainer').style.display = 'block';
                        renderCurrentQuestion();
                    }, 500);
                });
            } catch (error) {
                console.error('Failed to load Pyodide:', error);
                alert('Failed to load Python environment. Please refresh the page.');
            }
        }
        
        async function initializeQuiz() {
            console.log(`üöÄ Initializing Level ${currentLevel} quiz...`);
            
            // Initialize anti-cheating
            initializeAntiCheating();
            
            // Get user session
            try {
                const response = await fetch(`${API_BASE_URL}/session-info`, {
                    credentials: 'include',
                    mode: 'cors'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.username && data.email) {
                        currentUser = { username: data.username, email: data.email };
                    }
                }
            } catch (error) {
                console.log('Using test user');
            }
            
            // Start Pyodide if not already loaded
            if (!pyodideReady) {
                await initPyodide();
            } else {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('quizContainer').style.display = 'block';
                renderCurrentQuestion();
            }
            
            // Enable quiz monitoring
            isQuizActive = true;
        }
        
        function renderCurrentQuestion() {
            if (!questions.length) return;
            
            const container = document.getElementById('questionContainer');
            const question = questions[currentQuestionIndex];
            
            container.innerHTML = `
                <div class="question-card">
                    <!-- Question progress indicator -->
                    <div class="question-number">
                        Question ${currentQuestionIndex + 1} of ${questions.length} ‚Ä¢ Level ${currentLevel}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>${question.title}</h3>
                        <span class="badge bg-primary">${question.points} points</span>
                    </div>
                    <p class="mb-3">${question.description}</p>
                    <div class="alert alert-info">
                        <h6>Problem:</h6>
                        <pre style="white-space: pre-wrap;">${question.prompt}</pre>
                    </div>
                    <div class="explanation-section">
                        <h6>üìù Important:</h6>
                        <p>Include explanations as comments for full credit.</p>
                    </div>
                    <div id="editor-${question.id}" class="code-editor-container"></div>
                    <div class="test-cases">
                        <h6>Test Cases:</h6>
                        ${question.testCases.map((test, i) => `
                            <div><strong>Test ${i+1}:</strong> ${formatTestCase(test)}</div>
                        `).join('')}
                    </div>
                    <div id="testResults-${question.id}"></div>
                    
                    <!-- Question Navigation Buttons -->
                    <div class="question-navigation d-flex justify-content-between mt-4">
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}>‚Üê Previous</button>
                        <div class="text-center">
                            <button class="btn btn-info" onclick="runTests()">üß™ Run Tests</button>
                        </div>
                        <div>
                            ${currentQuestionIndex === questions.length - 1 ? 
                                `<button class="btn btn-success" onclick="submitQuiz()" id="submitBtn">üìä Submit Quiz</button>` :
                                `<button class="btn" id="nextBtn" onclick="nextQuestion()">Next ‚Üí</button>`
                            }
                        </div>
                    </div>
                </div>
            `;
            
            const editor = monaco.editor.create(document.getElementById(`editor-${question.id}`), {
                value: userAnswers[question.id] || question.starterCode,
                language: 'python',
                theme: 'vs-light',
                fontSize: 14,
                automaticLayout: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false
            });
            
            editors[question.id] = editor;
            editor.onDidChangeModelContent(() => {
                userAnswers[question.id] = editor.getValue();
            });
        }
        
        function formatTestCase(test) {
            const input = Array.isArray(test.input) ? test.input.join(', ') : test.input;
            const expected = JSON.stringify(test.expected);
            return `Input: ${input} ‚Üí Expected: ${expected}`;
        }
        
        async function executePythonTests(code, question) {
            if (!pyodideReady) throw new Error('Python environment not ready');
            
            const results = [];
            for (let i = 0; i < question.testCases.length; i++) {
                const testCase = question.testCases[i];
                try {
                    await pyodide.runPythonAsync(`for name in list(globals().keys()):
    if not name.startswith('__') and name not in ['sys']:
        try:
            del globals()[name]
        except:
            pass`);
                    
                    await pyodide.runPythonAsync(code);
                    
                    let functionCall;
                    if (Array.isArray(testCase.input)) {
                        functionCall = `${question.functionName}(${testCase.input.map(v => 
                            Array.isArray(v) ? JSON.stringify(v) : v
                        ).join(', ')})`;
                    } else {
                        functionCall = `${question.functionName}(${testCase.input})`;
                    }
                    
                    const result = await pyodide.runPythonAsync(functionCall);
                    let output = result && typeof result === 'object' && result.toJs ? 
                        result.toJs({ dict_converter: Object.fromEntries }) : result;
                    
                    results.push({
                        passed: deepEqual(output, testCase.expected),
                        output,
                        expected: testCase.expected,
                        error: null
                    });
                } catch (error) {
                    results.push({
                        passed: false,
                        output: null,
                        expected: testCase.expected,
                        error: error.message
                    });
                }
            }
            return results;
        }
        
        function deepEqual(a, b) {
            if (a === b) return true;
            if (a == null || b == null) return false;
            if (typeof a !== typeof b) return false;
            
            if (Array.isArray(a) && Array.isArray(b)) {
                if (a.length !== b.length) return false;
                for (let i = 0; i < a.length; i++) {
                    if (!deepEqual(a[i], b[i])) return false;
                }
                return true;
            }
            
            if (typeof a === 'object' && typeof b === 'object') {
                const keysA = Object.keys(a).sort();
                const keysB = Object.keys(b).sort();
                if (keysA.length !== keysB.length) return false;
                for (let key of keysA) {
                    if (!deepEqual(a[key], b[key])) return false;
                }
                return true;
            }
            
            return false;
        }
        
        async function runTests() {
            if (!pyodideReady) {
                alert('Python environment is still loading. Please wait...');
                return;
            }
            
            const question = questions[currentQuestionIndex];
            const code = editors[question.id].getValue();
            const resultsDiv = document.getElementById(`testResults-${question.id}`);
            resultsDiv.innerHTML = '<h6>üîß Running tests...</h6>';
            
            try {
                const testResults = await executePythonTests(code, question);
                let passedCount = 0;
                let testHtml = '<h6>Test Results:</h6>';
                
                testResults.forEach((result, i) => {
                    if (result.passed) passedCount++;
                    testHtml += `
                        <div class="test-result ${result.passed ? 'test-passed' : 'test-failed'}">
                            Test ${i+1}: ${result.passed ? '‚úì PASSED' : '‚úó FAILED'}
                            ${result.error ? `<br>Error: ${result.error}` : ''}
                            ${!result.passed && !result.error ? `<br>Expected: ${JSON.stringify(result.expected)}<br>Got: ${JSON.stringify(result.output)}` : ''}
                        </div>
                    `;
                });
                
                testHtml += `
                    <div class="mt-3">
                        <strong>Summary:</strong> ${passedCount}/${testResults.length} tests passed
                    </div>
                    <div class="mt-2">
                        <strong>Explanation Check:</strong>
                        ${checkExplanations(code) ? '‚úì Explanations found' : '‚ö† Add comments'}
                    </div>
                `;
                
                resultsDiv.innerHTML = testHtml;
            } catch (error) {
                console.error('Test execution error:', error);
                resultsDiv.innerHTML = `<div class="test-result test-failed">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function checkExplanations(code) {
            const comments = code.match(/#.+/g) || [];
            return comments.some(c => c.length > 20) && comments.length >= 2;
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderCurrentQuestion();
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderCurrentQuestion();
            }
        }
        
        async function submitQuiz() {
            if (!confirm('Submit your quiz? Make sure you\'ve tested all answers.')) return;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            isQuizActive = false;
            
            let totalScore = 0;
            const results = [];
            
            for (const question of questions) {
                const code = userAnswers[question.id] || '';
                try {
                    const testResults = await executePythonTests(code, question);
                    const passedTests = testResults.filter(r => r.passed).length;
                    const hasExplanations = checkExplanations(code);
                    const bonus = hasExplanations ? question.points * 0.2 : 0;
                    const score = Math.min(
                        Math.round((passedTests / testResults.length) * question.points) + bonus,
                        question.points
                    );
                    totalScore += score;
                    results.push({
                        questionId: question.id,
                        title: question.title,
                        type: 'coding',
                        code,
                        score,
                        maxScore: question.points,
                        passedTests,
                        totalTests: testResults.length,
                        hasExplanations,
                        difficulty: question.difficulty,
                        timeTaken: 0
                    });
                } catch (error) {
                    results.push({
                        questionId: question.id,
                        title: question.title,
                        type: 'coding',
                        code,
                        score: 0,
                        maxScore: question.points,
                        passedTests: 0,
                        totalTests: question.testCases.length,
                        hasExplanations: checkExplanations(code),
                        difficulty: question.difficulty,
                        error: error.message,
                        timeTaken: 0
                    });
                }
            }
            
            const maxScore = questions.reduce((sum, q) => sum + q.points, 0);
            const percentage = Math.round((totalScore / maxScore) * 100);
            
            const quizData = {
                username: currentUser.username,
                email: currentUser.email,
                topic: 'Linear Data Structures',
                score: totalScore,
                maxScore,
                percentage,
                level: currentLevel,
                questions: results,
                timestamp: new Date().toISOString(),
                cheatingAttempts,
                tabSwitches: tabSwitchCount
            };
            
            submittedQuizData = quizData;
            
            try {
                const response = await fetch(`${SUBMISSIONS_API}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(quizData)
                });
                
                if (response.ok) {
                    console.log('Quiz submitted successfully');
                    // Refresh user progress
                    await loadUserProgress();
                } else {
                    console.error('Failed to submit quiz');
                }
            } catch (error) {
                console.error('Submission error:', error);
            }
            
            showResults(quizData);
        }
        
        function showResults(quizData) {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('finalScore').textContent = `${quizData.score}/${quizData.maxScore}`;
            document.getElementById('finalPercentage').textContent = `${quizData.percentage}%`;
            document.getElementById('levelCompletionText').textContent = `Level ${currentLevel} Completed!`;
            
            // Show unlock message
            const unlockMessage = document.getElementById('unlockMessage');
            const nextLevelBtn = document.getElementById('nextLevelBtn');
            
            if (currentLevel === 1 && quizData.percentage >= 60) {
                unlockMessage.innerHTML = `<div class="alert alert-success">üéâ Level 2 Unlocked! Score ‚â• 60% achieved.</div>`;
                nextLevelBtn.style.display = 'inline-block';
            } else if (currentLevel === 2 && quizData.percentage >= 60) {
                unlockMessage.innerHTML = `<div class="alert alert-success">üéâ Level 3 Unlocked! Score ‚â• 60% achieved.</div>`;
                nextLevelBtn.style.display = 'inline-block';
            } else if (currentLevel === 3) {
                unlockMessage.innerHTML = `<div class="alert alert-success">üéä All Levels Completed! Congratulations!</div>`;
                nextLevelBtn.style.display = 'none';
            } else {
                unlockMessage.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Score ${quizData.percentage}% - Need ‚â• 60% to unlock next level</div>`;
                nextLevelBtn.style.display = 'none';
            }
            
            const detailedResults = document.getElementById('detailedResults');
            detailedResults.innerHTML = `
                <h4>Detailed Results</h4>
                ${quizData.cheatingAttempts > 0 ? `
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è ${quizData.cheatingAttempts} suspicious activities were detected.
                    </div>
                ` : ''}
                ${quizData.questions.map(q => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>${q.title}: ${q.score}/${q.maxScore} points</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar" style="width: ${(q.score/q.maxScore)*100}%"></div>
                            </div>
                            <small>Tests: ${q.passedTests}/${q.totalTests} | ${q.hasExplanations ? '‚úì Explained' : '‚ö† No explanation'}</small>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function showMyAnswers() {
            if (!submittedQuizData) {
                alert('No quiz data found.');
                return;
            }
            const answersList = document.getElementById('answersList');
            answersList.innerHTML = submittedQuizData.questions.map(q => `
                <div class="mb-4">
                    <h5>${q.title} (Score: ${q.score}/${q.maxScore})</h5>
                    <div class="code-block">${escapeHtml(q.code)}</div>
                </div>
            `).join('');
            document.getElementById('answersModal').style.display = 'flex';
        }
        
        function closeAnswersModal() {
            document.getElementById('answersModal').style.display = 'none';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function goToHome() {
            window.location.href = './iitm-pdsa.html';
        }



        // ===== INITIALIZATION =====
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize level UI
            loadUserProgress();
            
            // Start loading Pyodide in background
            initPyodide().catch(console.error);
        });


    </script>
</body>
</html>
