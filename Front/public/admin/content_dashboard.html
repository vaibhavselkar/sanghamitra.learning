<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="../assets/css/main.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 90%;
            margin-top: 30px;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table th {
            background: #27ae60;
            color: white;
        }

        .table-hover tbody tr:hover {
            background: #f1f1f1;
        }

        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .table-responsive {
            overflow-x: auto;
            position: relative;
        }

        .fixed-col {
            position: sticky;
            left: 0;
            background: white; /* Match table background */
            box-shadow: 2px 0px 5px rgba(0,0,0,0.1); /* Slight shadow for separation */
            z-index: 10;
            padding-bottom: 10px;
        }
        

    </style>
</head>
<body>
<main>
    <!-- Navbar with Activity Dashboard Button -->
    <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="../index.html" class="">Platfrom</a></li>
          <li><a href="activity_dashboard.html" class="">Activity Dashboard</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
    </nav>

    <div class="container">
        <h2 class="text-center mb-4">ðŸ“– Sanghamitra Learning Content Dashboard</h2>

        <!-- Math (Algebra) Section -->
        <div class="table-container">
            <h4 class="mb-3">
                Math (Algebra)  
                <span id="total-math" class="badge bg-primary">Loading...</span>
            </h4>
            <div id="loading-spinner-math" class="spinner-container">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center">
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Total</th>
                            <th>Easy</th>
                            <th>Medium</th>
                            <th>Hard</th>
                        </tr>
                    </thead>
                    <tbody id="table-body-math"></tbody>
                </table>
            </div>
        </div>

        <!-- Reading Comprehension Section -->
        <div class="table-container">
            <h4 class="mb-3">
                Reading Comprehension  
                <span id="total-reading" class="badge bg-primary">Loading...</span>
            </h4>
            <div id="loading-spinner-reading" class="spinner-container">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center">
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Total</th>
                            <th>Easy</th>
                            <th>Medium</th>
                            <th>Hard</th>
                        </tr>
                    </thead>
                    <tbody id="table-body-reading"></tbody>
                </table>
            </div>
        </div>

        <!-- Vocabulary Section -->
        <div class="table-container">
            <h4 class="mb-3">
                Vocabulary (CEFR Level vs Topics)  
                <span id="total-vocab" class="badge bg-primary">Loading...</span>
            </h4>
    
            <div id="loading-spinner-vocab-cefr" class="spinner-container">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
    
            <div class="table-responsive">
                <table class="table table-hover text-center">
                    <thead id="table-head-vocab-cefr">
                        <!-- Dynamic Column Headers -->
                    </thead>
                    <tbody id="table-body-vocab-cefr">
                        <!-- Dynamic Rows & Data -->
                    </tbody>
                </table>
            </div>
            <h4 class="mb-3">
                Vocabulary (Topics by Difficulty Level) 
            </h4>
            <div id="loading-spinner-vocab" class="spinner-container">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center">
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Total</th>
                            <th>Easy</th>
                            <th>Medium</th>
                            <th>Hard</th>
                        </tr>
                    </thead>
                    <tbody id="table-body-vocab"></tbody>
                </table>
            </div>
        </div>

        <div class="container">
            <div class="table-container">
                <h4 class="mb-3">
                    Writing Prompts  
                    <span id="total-writing-prompts" class="badge bg-primary">Loading...</span>
                </h4>
        
                <div id="loading-spinner-writing" class="spinner-container">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
        
                <div class="table-responsive">
                    <table class="table table-hover text-center">
                        <thead>
                            <tr>
                                <th>Topic</th>
                                <th>Total Prompts</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-writing">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</main>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>

    <!-- JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            fetchReadingContent();
            fetchVocabContent();
            fetchVocabularyCEFRData()
            fetchMathContent();
            fetchWritingPrompts()
        });
    
        // Generic Function to Process API Data
        function processContentData(data, tableBodyId, totalId) {
            const summary = {};
            let totalCount = data.length;
    
            // Update total count in heading
            document.getElementById(totalId).textContent = totalCount;
    
            // Categorize topics by difficulty levels
            data.forEach(item => {
                const topic = item.topic || item.topic_category;
                let level = item.difficultyLevel || item.passage_level;
    
                // âœ… Normalize Level Names (capitalize first letter)
                if (level) {
                    level = level.charAt(0).toUpperCase() + level.slice(1);
                }
    
                if (!summary[topic]) {
                    summary[topic] = { Easy: 0, Medium: 0, Hard: 0, Total: 0 };
                }

                if (level in summary[topic]) {
                    summary[topic][level]++;
                    summary[topic]["Total"]++;
                }
            });
    
            // Render table content
            renderTable(summary, tableBodyId);
        }
    
        function renderTable(summary, tableBodyId) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = "";
    
            Object.entries(summary).forEach(([topic, levels]) => {
                tableBody.innerHTML += `
                    <tr>
                        <td><strong>${topic}</strong></td>
                        <td><strong>${levels.Total}</strong></td>
                        <td>${levels.Easy}</td>
                        <td>${levels.Medium}</td>
                        <td>${levels.Hard}</td>
                    </tr>
                `;
            });
        }
    
        // Fetch Reading Comprehension Data
        async function fetchReadingContent() {
            try {
                const response = await fetch("http://localhost:4000/api/reading_passages");
                const data = await response.json();
                if (!data || !data.allpassages) throw new Error("No passages found.");
                processContentData(data.allpassages, "table-body-reading", "total-reading");
            } catch (error) {
                console.error("Error fetching Reading data:", error);
                document.getElementById("table-body-reading").innerHTML = `<tr><td colspan="4" class="text-danger">Failed to load data</td></tr>`;
            } finally {
                document.getElementById("loading-spinner-reading").style.display = "none";
            }
        }
    
        // Fetch Vocabulary Data
        async function fetchVocabContent() {
            try {
                const response = await fetch("http://localhost:4000/api/vocab-questions");
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error("Invalid vocab data format.");
                processContentData(data, "table-body-vocab", "total-vocab");
            } catch (error) {
                console.error("Error fetching Vocabulary data:", error);
                document.getElementById("table-body-vocab").innerHTML = `<tr><td colspan="4" class="text-danger">Failed to load data</td></tr>`;
            } finally {
                document.getElementById("loading-spinner-vocab").style.display = "none";
            }
        }
    
        // Fetch Math (Algebra) Data
        async function fetchMathContent() {
            try {
                const response = await fetch("http://localhost:4000/api/algebra_questions");
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error("Invalid math data format.");
                processContentData(data, "table-body-math", "total-math");
            } catch (error) {
                console.error("Error fetching Math data:", error);
                document.getElementById("table-body-math").innerHTML = `<tr><td colspan="4" class="text-danger">Failed to load data</td></tr>`;
            } finally {
                document.getElementById("loading-spinner-math").style.display = "none";
            }
        }

        async function fetchWritingPrompts() {
            try {
                const response = await fetch("http://localhost:4000/api/gre_writing_topics");
                const data = await response.json();

                if (!Array.isArray(data)) throw new Error("Invalid writing data format.");
                processWritingPrompts(data);
            } catch (error) {
                console.error("Error fetching Writing prompts:", error);
                document.getElementById("table-body-writing").innerHTML = `<tr><td colspan="2" class="text-danger">Failed to load data</td></tr>`;
            } finally {
                document.getElementById("loading-spinner-writing").style.display = "none";
            }
        }

        function processWritingPrompts(prompts) {
            const topicSummary = {};
            let totalPrompts = prompts.length;

            document.getElementById("total-writing-prompts").textContent = totalPrompts;

            // Group prompts by topic
            prompts.forEach(prompt => {
                const topic = prompt.topic_category;

                if (!topicSummary[topic]) {
                    topicSummary[topic] = 0;
                }

                topicSummary[topic]++;
            });

            renderWritingTable(topicSummary);
        }

        function renderWritingTable(topicSummary) {
            const tableBody = document.getElementById("table-body-writing");
            tableBody.innerHTML = "";

            Object.entries(topicSummary).forEach(([topic, count]) => {
                tableBody.innerHTML += `
                    <tr>
                        <td><strong>${topic}</strong></td>
                        <td>${count}</td>
                    </tr>
                `;
            });
        }

        async function fetchVocabularyCEFRData() {
            try {
                const response = await fetch("http://localhost:4000/api/vocab-questions");
                const vocabData = await response.json();

                if (!Array.isArray(vocabData)) throw new Error("Invalid vocabulary data format.");
                processVocabularyCEFR(vocabData);
            } catch (error) {
                console.error("Error fetching Vocabulary CEFR data:", error);
                document.getElementById("table-body-vocab-cefr").innerHTML = `<tr><td colspan="100" class="text-danger">Failed to load data</td></tr>`;
            } finally {
                document.getElementById("loading-spinner-vocab-cefr").style.display = "none";
            }
        }

        function processVocabularyCEFR(vocabData) {
            const topicSummary = {};

            // Categorizing vocabulary questions by CEFR level and topic
            vocabData.forEach(question => {
                const topic = question.topic;
                const level = question.CEFRLevel;

                if (!topicSummary[level]) {
                    topicSummary[level] = { Total: 0 }; // ðŸ”¥ Add Total field
                }

                if (!topicSummary[level][topic]) {
                    topicSummary[level][topic] = 0;
                }

                topicSummary[level][topic]++;
                topicSummary[level]["Total"]++; // ðŸ”¥ Increment Total Count
            });

            renderVocabularyCEFRTable(topicSummary);
        }

        function renderVocabularyCEFRTable(topicSummary) {
            const tableHead = document.getElementById("table-head-vocab-cefr");
            const tableBody = document.getElementById("table-body-vocab-cefr");

            // Extract unique topics (column headers)
            const topics = new Set();
            Object.values(topicSummary).forEach(levelData => {
                Object.keys(levelData).forEach(topic => topics.add(topic));
            });

            // Create table header with "Total" next to "CEFR Level"
            let headRow = `<tr><th class="fixed-col">CEFR Level</th>`;
            topics.forEach(topic => {
                headRow += `<th>${topic}</th>`;
            });
            headRow += `</tr>`;
            tableHead.innerHTML = headRow;

            // Create table body
            tableBody.innerHTML = "";
            Object.entries(topicSummary).forEach(([level, topicsData]) => {
                let row = `<tr><td class="fixed-col"><strong>${level}</strong></td><td><strong>${topicsData["Total"]}</strong></td>`;

                topics.forEach(topic => {
                    row += `<td>${topicsData[topic] || 0}</td>`; // Show 0 if no data
                });

                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }
    
    </script>
    
</body>
</html>
